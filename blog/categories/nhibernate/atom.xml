<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: nhibernate | Andrew Whitaker]]></title>
  <link href="http://www.andrewwhitaker.com/blog/categories/nhibernate/atom.xml" rel="self"/>
  <link href="http://www.andrewwhitaker.com/"/>
  <updated>2016-07-30T17:45:34-05:00</updated>
  <id>http://www.andrewwhitaker.com/</id>
  <author>
    <name><![CDATA[Andrew Whitaker]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Named Queries and Unmapped Types]]></title>
    <link href="http://www.andrewwhitaker.com/blog/2014/10/26/named-queries-and-unmapped-types/"/>
    <updated>2014-10-26T16:38:35-05:00</updated>
    <id>http://www.andrewwhitaker.com/blog/2014/10/26/named-queries-and-unmapped-types</id>
    <content type="html"><![CDATA[<p><em>This post was inspired by <a href="http://stackoverflow.com/q/26512930/497356">this StackOverflow question</a></em>.</p>

<p>Named queries are extremely useful in a variety of situations when you&rsquo;re using NHibernate. If you want to use dialect-specific features that aren&rsquo;t supported in NHibernate, you&rsquo;re practically forced to go this route.</p>

<p>Another (possibly less common scenario) is this: you&rsquo;re working with a database and want to use a stored procedure. For some reason you cannot change the stored procedure.</p>

<!-- more -->


<p>On the surface, this doesn&rsquo;t sound problematic: Just map the stored procedure to a named query and execute it. What if the stored procedure returns a resultset whose column names are less than ideal?</p>

<p>To make this problem a bit more concrete, here&rsquo;s a simple stored procedure written against the AdventureWorks database that I&rsquo;ll work with for the rest of the post:</p>

<p>```sql
create procedure [Products_GetAll]
as begin</p>

<pre><code>select
    [Production].[Product].[ProductID] as [prod_id],
    [Production].[Product].[Name] as [prod_name],
    [Production].[Product].[Color] as [prod_col]
from
    [Production].[Product];
</code></pre>

<p>end
```</p>

<p>Our result type, <code>ProductDTO</code> has property names we&rsquo;d expect:</p>

<p>```csharp
public class ProductDTO
{</p>

<pre><code>public int Id { get; set; }

public string Name { get; set; }

public string Color { get; set; }
</code></pre>

<p>}
```</p>

<p>With these pieces in mind, lets go over some possible solutions to our problem. I&rsquo;m assuming here that you don&rsquo;t want to just rename the properties on <code>ProductDTO</code>. You could certainly do that&mdash;however you&rsquo;d end up with some ugly property names, which is what we&rsquo;re trying to avoid.</p>

<p>So basically the rules are:</p>

<ul>
<li>We can&rsquo;t change the stored procedure</li>
<li>We want sane names for the properties in <code>ProductDTO</code></li>
</ul>


<h2>Map <code>ProductDTO</code></h2>

<p>Named queries can have a <code>&lt;return&gt;</code> element with a <code>class</code> attribute. If we went this route, our <code>.hbm.xml</code> file containing the named query might look like this:</p>

<p>```xml
&lt;hibernate-mapping xmlns=&ldquo;urn:nhibernate-mapping-2.2&rdquo;>
  &lt;sql-query name=&ldquo;Products_GetAll&rdquo;></p>

<pre><code>&lt;return class="AdventureWorks.ProductDTO"&gt;
  &lt;return-property name="ProductId" column="prod_id" /&gt;
  &lt;return-property name="ProductName" column="prod_name" /&gt;
  &lt;return-property name="ProductColor" column="prod_color" /&gt;
&lt;/return&gt;
exec [Products_GetAll];
</code></pre>

<p>  &lt;/sql-query>
&lt;/hibernate-mapping>
```</p>

<p>This looks like it would work right? The problem is that if you go this route, <code>ProductDTO</code> must be mapped. If you try using this mapping with an unmapped class, NHibernate will throw an exception stating that it doesn&rsquo;t know what <code>ProductDTO</code> is.</p>

<p>This might actually make sense depending on your architecture, but if the stored procedure we&rsquo;re executing is purpose-built for a particular area of our application, it probably doesn&rsquo;t make sense to do that. I&rsquo;m thinking specifically of a domain-driven architecture where domain entities are mapped to tables in a database. If that&rsquo;s the architecture we&rsquo;re using then adding a <code>GetAllProducts</code> entity doesn&rsquo;t really make sense.</p>

<p>Furthermore, this stored procedure is simply a <em>query</em>. It doesn&rsquo;t really make sense to map something that&rsquo;s just used to query the same way we&rsquo;d map a table to a class that can be inserted/updated.</p>

<p>There&rsquo;s also the limitation that the poster of the StackOverflow question above had&mdash;his or her query returned a resultset that did not have a column/columns that could be used as an identifier. NHibernate requires that mapped classes have a column or combination of columns that can uniquely identify the row.</p>

<h2>Use LINQ to transform the result of executing the named query</h2>

<p>This solution involves using <code>&lt;return-scalar&gt;</code> in our named query. In other words, an <code>.hbm.xml</code> file that looks like this:</p>

<p>```xml
&lt;hibernate-mapping xmlns=&ldquo;urn:nhibernate-mapping-2.2&rdquo;>
  &lt;sql-query name=&ldquo;Products_GetAll&rdquo;></p>

<pre><code>&lt;return-scalar column="prod_id" type="integer"/&gt;
&lt;return-scalar column="prod_name" type="string"/&gt;
&lt;return-scalar column="prod_col" type="string"/&gt;

exec [Products_GetAll];
</code></pre>

<p>  &lt;/sql-query>
&lt;/hibernate-mapping>
```</p>

<p>And our C# to get the <code>Product</code>s list would look like this:</p>

<p>```csharp
var products = session.GetNamedQuery(&ldquo;Products_GetAll&rdquo;)</p>

<pre><code>.List&lt;object[]&gt;()
.Select(obj =&gt; new ProductDTO
{
    Id = (int)obj[0],
    Name = (string)obj[1],
    Color = (string)obj[2]
})
.ToList();
</code></pre>

<p>```</p>

<p>This will work fine. The problem is that it can become very unmanageable with more than 10 properties. NHibernate is supposed to get rid of code like this anyway. It feels like there should be a better solution.</p>

<h2>Use a Custom ResultTransformer</h2>

<p>The reason we can&rsquo;t use a built-in result transformer (i.e. one in the <code>NHibernate.Transform</code> namespace) is because the one that would be most useful, <code>AliasToBeanTransformer</code>, requires that we map aliases from the query to properties on the class we want to project into.</p>

<p>Unfortunately NHibernate doesn&rsquo;t allow us to do this mapping with a named query. We can, however, create a new result transformer that allows us to do that. We&rsquo;re using the same XML mapping for our named query as before:</p>

<p>```xml
&lt;hibernate-mapping xmlns=&ldquo;urn:nhibernate-mapping-2.2&rdquo;>
  &lt;sql-query name=&ldquo;Products_GetAll&rdquo;></p>

<pre><code>&lt;return-scalar column="prod_id" type="integer"/&gt;
&lt;return-scalar column="prod_name" type="string"/&gt;
&lt;return-scalar column="prod_col" type="string"/&gt;

exec [Products_GetAll];
</code></pre>

<p>  &lt;/sql-query>
&lt;/hibernate-mapping>
```</p>

<p>Here are the steps you would take to map <code>ProductDTO</code> to the results of the query.</p>

<p><strong>1. Create an attribute that allows us to map column names to properties:</strong>
```csharp
using System;</p>

<p>[AttributeUsage(AttributeTargets.Property | AttributeTargets.Field, AllowMultiple = false)]
public class NHibernateQueryColumnAttribute : Attribute
{</p>

<pre><code>public NHibernateQueryColumnAttribute(string columnName)
{
    this.ColumnName = columnName;
}

public string ColumnName { get; private set; }
</code></pre>

<p>}
```</p>

<p><strong>2. Apply the attribute to our result class:</strong>
```csharp
public class ProductDTO
{</p>

<pre><code>[NHibernateQueryColumn("prod_id")]
public int Id { get; set; }

[NHibernateQueryColumn("prod_name")]
public string Name { get; set; }

[NHibernateQueryColumn("prod_col")]
public string Color { get; set; }
</code></pre>

<p>}
```</p>

<p><strong>3. Create a result transformer that can leverage that attribute (based on <a href="https://github.com/nhibernate/nhibernate-core/blob/master/src/NHibernate/Transform/AliasToBeanResultTransformer.cs"><code>AliasToBeanResultTransformer</code></a>:</strong>
```csharp
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using NHibernate;
using NHibernate.Transform;</p>

<p>public class QueryColumnAttributeTransformer<TResultType> : AliasedTupleSubsetResultTransformer
{</p>

<pre><code>private readonly ConstructorInfo constructor;
private readonly Dictionary&lt;string, MemberInfo&gt; memberColumnMap;
private readonly Type resultType = typeof(TResultType);

public QueryColumnAttributeTransformer()
{
    this.constructor = this.resultType.GetConstructor(
        BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance,
        null,
        Type.EmptyTypes,
        null);

    if (this.constructor == null &amp;&amp; this.resultType.IsClass)
    {
        throw new ArgumentException(
            "The target class of a QueryColumnAttributeTransformer needs a parameterless constructor");
    }

    const BindingFlags flags = BindingFlags.Public | BindingFlags.Instance;

    this.memberColumnMap = new Dictionary&lt;string, MemberInfo&gt;();

    MemberInfo[] members =
        this.resultType.GetProperties(flags)
            .Cast&lt;MemberInfo&gt;()
            .Concat(this.resultType.GetFields(flags))
            .ToArray();

    foreach (MemberInfo member in members)
    {
        var attr = member.GetCustomAttribute&lt;NHibernateQueryColumnAttribute&gt;();

        this.memberColumnMap.Add(attr == null ? member.Name : attr.ColumnName, member);
    }
}

public override bool IsTransformedValueATupleElement(string[] aliases, int tupleLength)
{
    return false;
}

public override object TransformTuple(object[] tuple, string[] aliases)
{
    if (aliases == null)
    {
        throw new ArgumentNullException("aliases");
    }

    object result;

    try
    {
        result = this.resultType.IsClass
            ? this.constructor.Invoke(null)
            : NHibernate.Cfg.Environment.BytecodeProvider.ObjectsFactory.CreateInstance(this.resultType, true);

        for (int i = 0; i &lt; aliases.Length; i++)
        {
            string alias = aliases[i];

            MemberInfo member;

            if (this.memberColumnMap.TryGetValue(alias, out member))
            {
                if (member.MemberType == MemberTypes.Property)
                {
                    ((PropertyInfo)member).SetValue(result, tuple[i]);
                }
                else if (member.MemberType == MemberTypes.Field)
                {
                    ((FieldInfo)member).SetValue(result, tuple[i]);
                }
            }
            else
            {
                throw new ArgumentException(
                    string.Format(
                        "{0} has no field or property mapped to column '{1}'", this.resultType, alias));
            }
        }
    }
    catch (MemberAccessException e)
    {
        throw new HibernateException("Could not instantiate result class: " + this.resultType, e);
    }

    return result;
}

public override IList TransformList(IList collection)
{
    return collection;
}
</code></pre>

<p>}
```</p>

<p><strong>4. Use the result transformer in the query:</strong>
```csharp
var products = session.GetNamedQuery(&ldquo;Products_GetAll&rdquo;)</p>

<pre><code>.SetResultTransformer(new QueryColumnAttributeTransformer&lt;ProductDTO&gt;())
.List&lt;ProductDTO&gt;();
</code></pre>

<p>```</p>

<p>If you don&rsquo;t like the idea of modifying your result class to accommodate the query, you could make a few changes to the transformer that would allow it to use a <code>Dictionary</code> mapping that you pass in instead.</p>

<p>Hope that helps someone out there. And if there&rsquo;s an easier way to accomplish this, please let me know.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting NHibernate Up and Running Quickly]]></title>
    <link href="http://www.andrewwhitaker.com/blog/2014/08/28/getting-nhibernate-up-and-running-quickly/"/>
    <updated>2014-08-28T10:44:06-05:00</updated>
    <id>http://www.andrewwhitaker.com/blog/2014/08/28/getting-nhibernate-up-and-running-quickly</id>
    <content type="html"><![CDATA[<p>NHibernate can seem like a daunting library to set up. The configuration can get quite complicated&mdash;XML mappings, code mappings, mapping conventions, dialects, logging, etc. Sometimes you just want to get something up and running to test out a query or play around with a database other than your primary one. In this post, I&rsquo;ll show you how to get up and running with NHibernate in about 5 minutes and in around 50 lines of code in <a href="http://www.linqpad.net">LINQPad</a>.</p>

<p>This assumes you already have a database configured and ready to create new tables and connect to with NHibernate.</p>

<!-- more -->


<h2>1. Create your database table</h2>

<p>I&rsquo;ll use MySQL as an example, but first you&rsquo;ll need to create a database table (or a few tables) that you want to play around with. I&rsquo;ll create a <code>person</code> table:</p>

<p><code>sql
CREATE TABLE `person` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `FirstName` varchar(200) NOT NULL,
  `BirthDate` date NOT NULL,
  `LastName` varchar(200) NOT NULL,
  PRIMARY KEY (`Id`)
)
</code></p>

<h2>2. Prepare your LINQPad Query</h2>

<p>After creating a new query in LINQPad, set the <strong>Language</strong> to <strong>C# Program</strong>, then press F4 to open the <strong>Query Properties</strong> window. From here you can browse to the &ldquo;NHibernate.dll&rdquo; file that you&rsquo;d like to use. I&rsquo;ll also add MySql.Data.dll since I need to interact with a MySql database:</p>

<p><img src="/images/posts/2014-08-28-getting-nhibernate-up-and-running-quickly-linqpad-query-properties/linqpad-query-properties.png"></p>

<p>Next, go over to the <strong>Additional Namespace Imports</strong> tab and add the following namespaces:</p>

<p><code>
NHibernate
NHibernate.Cfg
NHibernate.Cfg.MappingSchema
NHibernate.Dialect
NHibernate.Mapping.ByCode
NHibernate.Mapping.ByCode.Conformist
</code></p>

<p>Okay, that&rsquo;s all we should need to get started with actually writing the query.</p>

<h2>3. Add some configuration code</h2>

<p>Next we&rsquo;ll actually configure NHibernate to connect to the database correctly. Normally you would configure NHibernate via your project&rsquo;s *.config file, but since we&rsquo;re using LINQPad, a configuration file isn&rsquo;t really feasible. Luckily, we can configure NHibernate in C# using the <code>.DatabaseIntegration</code> extension method:</p>

<p>```csharp
void Main()
{</p>

<pre><code>Configuration cfg = new Configuration()
    .DataBaseIntegration(db =&gt;
    {
        db.ConnectionString = "Server=127.0.0.1;Database=test;Uid=nhibernate;Pwd=nhibernate;";
        db.Dialect&lt;MySQLDialect&gt;();
    });
</code></pre>

<p>}
```</p>

<p>Here I&rsquo;m just specifying the dialect I&rsquo;d like to use (<code>MySQLDialect</code>) and setting my connection string.</p>

<h2>4. Add an entity and mapping</h2>

<p>Since I created a <code>person</code> table earlier, I&rsquo;m going to go ahead and create a <code>Person</code> class and <code>PersonMap</code> to map that class using NHibernate&rsquo;s mapping-by-code. This code goes just under the <code>Main</code> method we filled in earlier. Here&rsquo;s the entity:</p>

<p>```csharp
public class Person
{</p>

<pre><code>public virtual int Id { get; set; }

public virtual string FirstName { get; set; }

public virtual string LastName { get; set; }

public virtual DateTime BirthDate { get; set; }
</code></pre>

<p>}
```</p>

<p>Here&rsquo;s the mapping:</p>

<p>```csharp
public class PersonMap : ClassMapping<Person>
{</p>

<pre><code>public PersonMap()
{
    this.Table("person");
    this.Id(p =&gt; p.Id);
    this.Property(p =&gt; p.FirstName);
    this.Property(p =&gt; p.LastName);        
    this.Property(p =&gt; p.BirthDate);
}
</code></pre>

<p>}
```</p>

<h2>5. Add code to process the mapping we added</h2>

<p>The last configuration step is to modify our <code>Main</code> method to incorporate our mappings into the configuration. We&rsquo;ll modify our <code>Main</code> method as follows:</p>

<p>```csharp
void Main()
{</p>

<pre><code>Configuration cfg = new Configuration()
    .DataBaseIntegration(db =&gt;
    {
        db.ConnectionString = "Server=127.0.0.1;Database=test;Uid=nhibernate;Pwd=nhibernate;";
        db.Dialect&lt;MySQLDialect&gt;();
    });

/* Add the mapping we defined: */
var mapper = new ModelMapper();
mapper.AddMappings(Assembly.GetExecutingAssembly().GetExportedTypes());

HbmMapping mapping = mapper.CompileMappingForAllExplicitlyAddedEntities();
cfg.AddMapping(mapping);
</code></pre>

<p>}
```</p>

<h2>6. Create an <code>ISessionFactory</code>, <code>ISession</code> and <code>ITransaction</code> and write a query</h2>

<p>Ok the last step is to build an <code>ISessionFactory</code> from our configuration. From there we can get an <code>ISession</code> and an <code>ITransaction</code> to actually work with the entities we&rsquo;ve created and mapped. We&rsquo;ll modify the <code>Main</code> method again as follows:</p>

<p>```csharp
void Main()
{</p>

<pre><code>Configuration cfg = new Configuration()
    .DataBaseIntegration(db =&gt;
    {
        db.ConnectionString = "Server=127.0.0.1;Database=test;Uid=nhibernate;Pwd=nhibernate;";
        db.Dialect&lt;MySQLDialect&gt;();
    });

/* Add the mapping we defined: */
var mapper = new ModelMapper();
mapper.AddMappings(Assembly.GetExecutingAssembly().GetExportedTypes());

HbmMapping mapping = mapper.CompileMappingForAllExplicitlyAddedEntities();

cfg.AddMapping(mapping);   

/* Create a session and execute a query: */
using (ISessionFactory factory = cfg.BuildSessionFactory())
using (ISession session = factory.OpenSession())
using (ITransaction tx = session.BeginTransaction())
{
    session.Get&lt;Person&gt;(1).Dump();

    tx.Commit();
}
</code></pre>

<p>}
```</p>

<p>&hellip;And that&rsquo;s really it. If you hit <strong>F5</strong> or the green play button in LINQPad, your query should run, assuming you have everything configured correctly. Here&rsquo;s the whole listing below, just in case:</p>

<p>```csharp
void Main()
{</p>

<pre><code>Configuration cfg = new Configuration()
    .DataBaseIntegration(db =&gt;
    {
        db.ConnectionString = "Server=127.0.0.1;Database=test;Uid=nhibernate;Pwd=nhibernate;";
        db.Dialect&lt;MySQLDialect&gt;();
    });

/* Add the mapping we defined: */
var mapper = new ModelMapper();
mapper.AddMappings(Assembly.GetExecutingAssembly().GetExportedTypes());

HbmMapping mapping = mapper.CompileMappingForAllExplicitlyAddedEntities();

cfg.AddMapping(mapping);

/* Create a session and execute a query: */
using (ISessionFactory factory = cfg.BuildSessionFactory())
using (ISession session = factory.OpenSession())
using (ITransaction tx = session.BeginTransaction())
{
    session.Get&lt;Person&gt;(1).Dump();

    tx.Commit();
}
</code></pre>

<p>}</p>

<p>public class PersonMap : ClassMapping<Person>
{</p>

<pre><code>public PersonMap()
{
    this.Table("person");
    this.Id(p =&gt; p.Id);
    this.Property(p =&gt; p.FirstName);
    this.Property(p =&gt; p.LastName);        
    this.Property(p =&gt; p.BirthDate);
}
</code></pre>

<p>}</p>

<p>public class Person
{</p>

<pre><code>public virtual int Id { get; set; }

public virtual string FirstName { get; set; }

public virtual string LastName { get; set; }

public virtual DateTime BirthDate { get; set; }
</code></pre>

<p>}
```</p>

<h2>Summary</h2>

<p>Hopefully this post will come in handy if you&rsquo;re looking to quickly get NHibernate up and running for some throwaway or experimental code. When you boil the setup down to the very basics it&rsquo;s actually not that bad at all. From here, you can make some configuration changes or enhancements. Two useful configuration options to turn on inside of the <code>.DatabaseIntegration</code> method are the <code>LogFormattedSql</code> property and the <code>LogSqlInConsole</code> property. These will allow you to actually see the SQL that NHibernate is generating.</p>
]]></content>
  </entry>
  
</feed>
