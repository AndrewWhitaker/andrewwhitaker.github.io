
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>QueryOver Series - Part 7: Using SQL Functions - Andrew Whitaker</title>
  <meta name="author" content="Andrew Whitaker">

  
  <meta name="description" content="In this post, I&rsquo;ll go over how to use functions built into the database engine. This can be useful when you want to do some work inside of your &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.andrewwhitaker.com/blog/2014/08/15/queryover-series-part-7-using-sql-functions/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <link href="/atom.xml" rel="alternate" title="Andrew Whitaker" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Andrew Whitaker</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.andrewwhitaker.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/queryover-series">QueryOver Series</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">QueryOver Series - Part 7: Using SQL Functions</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-15T14:46:35-05:00" pubdate data-updated="true">Aug 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In this post, I&rsquo;ll go over how to use functions built into the database engine. This can be useful when you want to do some work inside of your SQL query rather than do post-processing on the result set you get back.</p>

<!-- more -->


<p><em>This article is part of an ongoing series on NHibernate Queryover. Click <a href="/queryover-series">here</a> to see the table of contents.</em></p>

<h2>Dialects in NHibernate</h2>

<p>To understand how to use and later build SQL functions, it&rsquo;s helpful to understand how the default SQL functions are registered with NHibernate to begin with.</p>

<p>NHibernate has the concept of a SQL <em>dialect</em>, a vendor-specific flavor of SQL. As you probably know, <a href="http://www.nhforge.org/doc/nh/en/#configuration-optional-dialects">many dialects are supported out of the box</a>. NHibernate represents dialects with a class per supported dialect.</p>

<p>The <code>Dialect</code> base class registers required functions for a dialect using ANSI-92 standards. If a dialect implements a function differently, that dialect must overwrite the base class&#8217; implementation with its own.</p>

<p>For example, SQL Server doesn&rsquo;t implement the ANSI-92 <code>TRIM</code> function, so the <code>MsSql2000</code> dialect class uses a different implementation than the base class (which ultimately calls <code>rtrim</code> and <code>ltrim</code> to simulate the ANSI standard).</p>

<p>It&rsquo;s worth looking over the <code>Dialect</code> base class and possibly the dialect class for the database engine you&rsquo;re using to see what functions are already available to you.</p>

<h2>Calling functions from your queries</h2>

<p>There are two ways to actually use SQL functions inside of your queries.</p>

<h3>Using <code>Projections.SqlFunction</code></h3>

<p>Using already registered SQL functions is fairly simple, using <code>Projections.SqlFunction</code>. For example, here&rsquo;s a query that gets every <code>Person</code>&rsquo;s middle name, or &ldquo;Not Applicable&rdquo; if <code>MiddleName</code> is <code>null</code>, using the <code>COALESCE</code> function:</p>

<p><strong>QueryOver</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">middleNames</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span><span class="s">&quot;coalesce&quot;</span><span class="p">,</span> <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">MiddleName</span><span class="p">),</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="s">&quot;Not Applicable&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>SQL</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>  <span class="n">COALESCE</span> <span class="p">(</span><span class="n">this_</span><span class="p">.</span><span class="n">MiddleName</span><span class="p">,</span> <span class="s1">&#39;Not Applicable&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">y0_</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">Person</span><span class="p">.</span><span class="n">Person</span> <span class="n">this_</span>
</span></code></pre></td></tr></table></div></figure>


<p>This same pattern applies to all SQL functions that you&rsquo;d like to call using <code>Projections.SqlFunction</code>.</p>

<h3>Using <code>ProjectionsExtensions</code></h3>

<p>Inside of a QueryOver query, there&rsquo;s actually a better way to call many of the most common SQL functions. The <code>ProjectionsExtensions</code> class inside of the <code>NHibernate.Criterion</code> namespace contains extension methods that are parsed into SQL function calls.</p>

<p>For example, here&rsquo;s a query using the <code>.Upper</code> extension method. Note that these extension methods are actually on the object&rsquo;s properties:</p>

<p><strong>QueryOver</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">middleNames</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">FirstName</span><span class="p">.</span><span class="n">Upper</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>SQL</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>  <span class="k">UPPER</span> <span class="p">(</span><span class="n">this_</span><span class="p">.</span><span class="n">FirstName</span><span class="p">)</span> <span class="k">AS</span> <span class="n">y0_</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">Person</span><span class="p">.</span><span class="n">Person</span> <span class="n">this_</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is much cleaner than the alternative using <code>Projections.SqlFunction</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">names</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span>
</span><span class='line'>            <span class="s">&quot;upper&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">FirstName</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using your own functions</h2>

<p>In most cases, functions you want to use will already be registered in the dialect you&rsquo;re using. In some cases, however, you&rsquo;ll want to add a function that&rsquo;s not been registered. In this section of the post, I&rsquo;ll go over how to add the <code>checksum</code> function in SQL Server. There are a few steps involved in using your own function, I&rsquo;ll go over each one in detail.</p>

<p>There are actually two ways to invoke a custom SQL function from your queries. You can either add the function &ldquo;statically&rdquo; to a custom dialect, or invoke a brand new function &ldquo;dynamically&rdquo; at runtime that&rsquo;s not registered with the dialect.</p>

<h3>Adding your own dialect</h3>

<p>As I discussed earlier, functions are registered in the dialect class representing the database flavor you&rsquo;re using. Since we can&rsquo;t modify those classes directly to register our function, we&rsquo;ll create a new dialect that&rsquo;s a subclass of the one we&rsquo;re using.</p>

<p>Since I&rsquo;m using SQL Server in this example, I&rsquo;ll create a custom dialect that&rsquo;s a subclass of <code>MsSql2012Dialect</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">NHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">NHibernate.Dialect</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">NHibernate.Dialect.Function</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AdventureWorksDialect</span> <span class="p">:</span> <span class="n">MsSql2012Dialect</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">AdventureWorksDialect</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">RegisterFunction</span><span class="p">(</span><span class="s">&quot;checksum&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">StandardSQLFunction</span><span class="p">(</span><span class="s">&quot;checksum&quot;</span><span class="p">,</span> <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we need to make sure our application is using the new dialect. We can do this either in our configuration code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">cfg</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Configuration</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Configure</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">DataBaseIntegration</span><span class="p">(</span><span class="n">db</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">db</span><span class="p">.</span><span class="n">Dialect</span><span class="p">&lt;</span><span class="n">AdventureWorksDialect</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or, in our config file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;hibernate-configuration</span> <span class="na">xmlns=</span><span class="s">&quot;urn:nhibernate-configuration-2.2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;session-factory&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;show_sql&quot;</span><span class="nt">&gt;</span>false<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connection.driver_class&quot;</span><span class="nt">&gt;</span>NHibernate.Driver.Sql2008ClientDriver<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dialect&quot;</span><span class="nt">&gt;</span>AdventureWorks.Database.AdventureWorksDialect<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connection.connection_string_name&quot;</span><span class="nt">&gt;</span>AdventureWorks<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/session-factory&gt;</span>
</span><span class='line'><span class="nt">&lt;/hibernate-configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Calling the function using <code>Projections.SqlFunction</code></h4>

<p>If all you want to do is call a function using <code>Projections.SqlFunction</code>, you&rsquo;re basically done. All you need to do is call the function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">checksums</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;checksum&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will yield the following SQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>  <span class="n">CHECKSUM</span> <span class="p">(</span><span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span><span class="p">,</span> <span class="n">this_</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">y0_</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">Production</span><span class="p">.</span><span class="n">Product</span> <span class="n">this_</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h4>Creating a custom projections class</h4>

<p>Using <code>Projections.SqlFunction</code> isn&rsquo;t quite satisfactory, especially after seeing the built-in <code>ProjectionExtensions</code>. We can easily create a <code>CustomProjections</code> class that provides some syntactic sugar for calling our custom function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CustomProjections</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">Checksum</span><span class="p">(</span><span class="k">params</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;[]</span> <span class="n">properties</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">Checksum</span><span class="p">(</span><span class="n">properties</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">).</span><span class="n">ToArray</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">Checksum</span><span class="p">(</span><span class="k">params</span> <span class="n">IProjection</span><span class="p">[]</span> <span class="n">projections</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span><span class="s">&quot;checksum&quot;</span><span class="p">,</span> <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span> <span class="n">projections</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that we have two overloads of <code>Checksum</code>, one that takes an array of <code>Expression&lt;Func&lt;object&gt;&gt;</code>s and another that takes an array of <code>IProjection</code>s.</p>

<p>Using the <code>Expression&lt;Func&lt;object&gt;&gt;[]</code> overload is convenient when we don&rsquo;t need to combine the use of <code>checksum</code> with other functions, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">checksums</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">CustomProjections</span><span class="p">.</span><span class="n">Checksum</span><span class="p">(</span>
</span><span class='line'>        <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
</span><span class='line'>        <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the <code>IProjection[]</code> overload is useful when we need to supply <code>checksum</code> with the result of calling <em>another</em> function, say <code>avg</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Get the `checksum` of the average price for each sell start date.</span>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;</span> <span class="n">checksums</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectGroup</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">SellStartDate</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span>
</span><span class='line'>            <span class="n">CustomProjections</span><span class="p">.</span><span class="n">Checksum</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Projections</span><span class="p">.</span><span class="n">Avg</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>StandardSQLFunction</code> and <code>SQLFunctionTemplate</code></h4>

<p>If you look through <a href="https://github.com/nhibernate/nhibernate-core/tree/master/src/NHibernate/Dialect/Function">NHibernate&rsquo;s implementations of various SQL functions</a>, you might notice that many use <code>StandardSQLFunction</code> and <code>SQLFunctionTemplate</code>. These should take care of most of your custom function needs. If not, you can always implement <code>ISQLFunction</code> and create your own implementation.</p>

<h5><code>StandardSQLFunction</code></h5>

<p>We used <code>StandardSQLFunction</code> to implement our <code>checksum</code> example. Basically, <code>StandardSQLFunction</code> allows you to implement a SQL function that takes an arbitrary number of arguments and returns a scalar value.</p>

<h5><code>SQLFunctionTemplate</code></h5>

<p><code>SQLFunctionTemplate</code> is a bit more sophisticated, and you can use it to implement SQL functions with a <em>template</em>, like the name implies. This is typically useful when you want to require a function to have a specific number of arguments.</p>

<p>An example of this would be the <code>stuff</code> <a href="http://msdn.microsoft.com/en-us/library/ms188043.aspx">function in SQL Server</a>. This function inserts one string into another string, deleting the specified number of characters from the first string at a start index, then inserts the second string.</p>

<p>For example, here&rsquo;s how you could use <code>stuff</code> to replace &ldquo;C++&rdquo; with &ldquo;C#&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">select</span> <span class="nf">stuff</span><span class="p">(</span><span class="err">&#39;</span><span class="n">C</span><span class="p">++</span><span class="err">&#39;</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since <code>stuff</code> has a fixed number of parameters, it&rsquo;s a good candidate for <code>SQLFunctionTemplate</code>. All we have to do to register it in our dialect is add the following line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">this</span><span class="p">.</span><span class="n">RegisterFunction</span><span class="p">(</span><span class="s">&quot;stuff&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">SQLFunctionTemplate</span><span class="p">(</span><span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span> <span class="s">&quot;stuff(?1, ?2, ?3, ?4)&quot;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we&rsquo;re basically just saying that <code>stuff</code> is a function whose syntax is invoking the <code>stuff</code> function with exactly four parameters.</p>

<p>We&rsquo;ll add a few more static methods to our <code>CustomProjections</code> class, since there are several ways we might want to call this function, we&rsquo;ll provide several overloads:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Usage: CustomProjections.Stuff(() =&gt; alias.Property, 1, 2, () =&gt; alias.OtherProperty)</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">Stuff</span><span class="p">(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">characterExpression</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">replaceWithExpression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Stuff</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">characterExpression</span><span class="p">),</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">replaceWithExpression</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Usage: CustomProjections.Stuff(Projections.Property(..), 1, 2, Projections.Constant(...))</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">Stuff</span><span class="p">(</span><span class="n">IProjection</span> <span class="n">characterExpression</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">IProjection</span> <span class="n">replaceWithExpression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span><span class="s">&quot;stuff&quot;</span><span class="p">,</span> <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">String</span><span class="p">,</span> <span class="n">characterExpression</span><span class="p">,</span> <span class="n">Projections</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">Projections</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="n">replaceWithExpression</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Usage: CustomProjections.Stuff(() =&gt; alias.Property, 1, 2, &quot;Replacement&quot;)</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">Stuff</span><span class="p">(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">characterExpression</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">string</span> <span class="n">replaceWithExpression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Stuff</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">characterExpression</span><span class="p">),</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">Projections</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">replaceWithExpression</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s an example of how it would be used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">stuffResults</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span>
</span><span class='line'>            <span class="n">CustomProjections</span><span class="p">.</span><span class="n">Stuff</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="s">&quot;PR&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Invoking new functions at runtime</h3>

<p>If, for some reason, you don&rsquo;t want to create a custom dialect and register functions there, you can still invoke an unregistered SQL function. There&rsquo;s an overload of <code>Projections.SqlFunction</code> that takes an <code>ISQLFunction</code> that you can define at runtime. For example, if we had not registered our <code>checksum</code> function, you could call it dynamically like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">StandardSQLFunction</span><span class="p">(</span><span class="s">&quot;checksum&quot;</span><span class="p">),</span>
</span><span class='line'>    <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Name</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we&rsquo;re defining and using the <code>checksum</code> function in one shot.</p>

<p>There <em>is</em> a disadvantage to using this method. When you register a function with the dialect instead, NHibernate adds the function to an internal cache and reuses the function definition whenever you access it by name.</p>

<p>Creating a new <code>checksum</code> function every time we needed to call the SQL Server <code>checksum</code> function would be wasteful&mdash;it would be better to define the function once and have NHibernate cache and reuse it.</p>

<p>However, we may want to leverage invoking a function dynamically to take care of special SQL functions, like SQL Server&rsquo;s <code>datediff</code> function.</p>

<h4>Implementing SQL Server&rsquo;s <code>datediff</code> function.</h4>

<p>SQL Server has a <a href="http://msdn.microsoft.com/en-us/library/ms189794%28SQL.90%29.aspx">function</a> called <code>datediff</code> that returns the number of &ldquo;date parts&rdquo; between a given start and end date.</p>

<p>At first glance, it seems like we could register <code>datediff</code> using <code>SQLFunctionTemplate</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">new</span> <span class="nf">SQLFunctionTemplate</span><span class="p">(</span><span class="s">&quot;datediff(?1, ?2, ?3)&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem here is that <code>datediff</code>&rsquo;s first parameter is a SQL server keyword and <em>cannot</em> be supplied as a variable. According to MSDN:</p>

<blockquote><p>These dateparts and abbreviations cannot be supplied as a user-declared variable.</p></blockquote>

<p>So that means we can&rsquo;t call <code>datediff</code> and supply the <code>datepart</code> dynamically. We could register a function for every possible version of <code>datediff</code> and name them all slightly differently:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">RegisterFunction</span><span class="p">(</span><span class="s">&quot;datediff-yr&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">SQLFunctionTemplate</span><span class="p">(</span><span class="s">&quot;datediff(yy, ?1, ?2)&quot;</span><span class="p">));</span>
</span><span class='line'><span class="n">RegisterFunction</span><span class="p">(</span><span class="s">&quot;datediff-dd&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">SQLFunctionTemplate</span><span class="p">(</span><span class="s">&quot;datediff(dd, ?1, ?2)&quot;</span><span class="p">));</span>
</span><span class='line'><span class="cm">/* etc, for each valid datepart */</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m not sure about you but this makes me cringe. Luckily there&rsquo;s a better solution. We can use NHibernate&rsquo;s ability to run an arbitrary, unregistered SQL function to dynamically create and execute the various versions of <code>datediff</code>. Here&rsquo;s the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DateProjections</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DateDiffFormat</span> <span class="p">=</span> <span class="s">&quot;datediff({0}, ?1, ?2)&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">DateDiff</span><span class="p">(</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">datepart</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">startDate</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">endDate</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Build the function template based on the date part.</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">functionTemplate</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">DateDiffFormat</span><span class="p">,</span> <span class="n">datepart</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">SQLFunctionTemplate</span><span class="p">(</span><span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span> <span class="n">functionTemplate</span><span class="p">),</span>
</span><span class='line'>            <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">startDate</span><span class="p">),</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">endDate</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we&rsquo;re able to write queries using any date part we want without having to register a separate function for each date part. For example, here&rsquo;s a query that gets the <code>datediff</code> in days, quarters, and months:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;</span> <span class="n">checksums</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">DateProjections</span><span class="p">.</span><span class="n">DateDiff</span><span class="p">(</span><span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">SellStartDate</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">SellEndDate</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">DateProjections</span><span class="p">.</span><span class="n">DateDiff</span><span class="p">(</span><span class="s">&quot;qq&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">SellStartDate</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">SellEndDate</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">DateProjections</span><span class="p">.</span><span class="n">DateDiff</span><span class="p">(</span><span class="s">&quot;mm&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">SellStartDate</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">SellEndDate</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This still isn&rsquo;t perfect. You might have realized that we&rsquo;re still at a disadvantage since we&rsquo;re not using cached versions of our function definitions. One good solution to this is to use our own cache for the various <code>datediff</code> flavors. Here&rsquo;s what our class looks like with that modification:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DateProjections</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DateDiffFormat</span> <span class="p">=</span> <span class="s">&quot;datediff({0}, ?1, ?2)&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Maps datepart to an ISQLFunction</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ISQLFunction</span><span class="p">&gt;</span> <span class="n">DateDiffFunctionCache</span> <span class="p">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ISQLFunction</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IProjection</span> <span class="nf">DateDiff</span><span class="p">(</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">datepart</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">startDate</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">endDate</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">ISQLFunction</span> <span class="n">sqlFunction</span> <span class="p">=</span> <span class="n">GetDateDiffFunction</span><span class="p">(</span><span class="n">datepart</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">Projections</span><span class="p">.</span><span class="n">SqlFunction</span><span class="p">(</span>
</span><span class='line'>            <span class="n">sqlFunction</span><span class="p">,</span>
</span><span class='line'>            <span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">startDate</span><span class="p">),</span>
</span><span class='line'>            <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">endDate</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">ISQLFunction</span> <span class="nf">GetDateDiffFunction</span><span class="p">(</span><span class="kt">string</span> <span class="n">datepart</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">ISQLFunction</span> <span class="n">sqlFunction</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">DateDiffFunctionCache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">datepart</span><span class="p">,</span> <span class="k">out</span> <span class="n">sqlFunction</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">string</span> <span class="n">functionTemplate</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">DateDiffFormat</span><span class="p">,</span> <span class="n">datepart</span><span class="p">);</span>
</span><span class='line'>            <span class="n">sqlFunction</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SQLFunctionTemplate</span><span class="p">(</span><span class="n">NHibernateUtil</span><span class="p">.</span><span class="n">Int32</span><span class="p">,</span> <span class="n">functionTemplate</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">DateDiffFunctionCache</span><span class="p">[</span><span class="n">datepart</span><span class="p">]</span> <span class="p">=</span> <span class="n">sqlFunction</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">sqlFunction</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;re caching our function definitions so that we&rsquo;re not redefining versions of <code>datediff</code> unnecessarily.</p>

<p>Another enhancement that probably should be made is to make the <code>datepart</code> argument of <code>DateProjections.DateDiff</code> strongly typed. A good solution there would be to use an <code>enum</code> defining the possible <code>datepart</code> values. Then you could use a <code>Dictionary&lt;DatePart, string&gt;</code> to map from <code>enum</code> values to strings.</p>

<h2>Summary</h2>

<p>Calling built-in SQL functions from NHibernate queries has been written about many times before, but hopefully I was able to shed some light on how those functions are registered and invoked. In summary:</p>

<ul>
<li>You can either register a function by using a custom dialect and invoke it by name later, or define and invoke the function in one step.</li>
<li>Registering a function with a custom dialect is often the best option since the function definition is cached and reused automatically by NHibernate.</li>
<li><code>StandardSQLFunction</code> and <code>SQLFunctionTemplate</code> are implementations of <code>ISQLFunction</code> that enable easily defining SQL functions.</li>
<li>Using a custom projections class is a useful abstraction to lay on top of <code>Projections.SqlFunction</code> to make code easier to read and more robust.</li>
<li>You can use NHibernate&rsquo;s ability to call SQL functions at runtime to implement the <code>datediff</code> function in a clean way.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew Whitaker</span></span>

      








  


<time datetime="2014-08-15T14:46:35-05:00" pubdate data-updated="true">Aug 15<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nhibernate/'>NHibernate</a>, <a class='category' href='/blog/categories/queryover/'>QueryOver</a>, <a class='category' href='/blog/categories/queryover-series/'>QueryOver Series</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/08/07/queryover-series-part-6-query-building-techniques/" title="Previous Post: QueryOver Series - Part 6: Query Building Techniques">&laquo; QueryOver Series - Part 6: Query Building Techniques</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/28/getting-nhibernate-up-and-running-quickly/" title="Next Post: Getting NHibernate Up and Running Quickly">Getting NHibernate Up and Running Quickly &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/31/queryover-series-part-10-combining-criteria-and-queryover/">QueryOver Series - Part 10: Combining Criteria and QueryOver</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/28/queryover-series-part-9-extending-queryover-using-custom-methods-and-properties/">QueryOver Series - Part 9: Extending QueryOver to Use Custom Methods and Properties</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/26/named-queries-and-unmapped-types/">Named Queries and Unmapped Types</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/queryover-series-part-8-working-with-subqueries/">QueryOver Series Part 8: Working with Subqueries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/28/getting-nhibernate-up-and-running-quickly/">Getting NHibernate Up and Running Quickly</a>
      </li>
    
  </ul>
</section>





<section>
  <h1>Stack Overflow</h1>
  <a style="text-decoration:none;" href="http://stackoverflow.com/users/497356/andrew-whitaker">
    <img src="http://stackoverflow.com/users/flair/497356.png" width="208" height="58" alt="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
  </a>
  <h2>Recent Answers:</h2> 
  <ul id="stackoverflow-answers">
  </ul>
</section>
<style>
#stackoverflow-answers > li {
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

#stackoverflow-answers > li > .score {
    margin-right: 5px;
    padding: 3px 6px 6px 6px;
}

#stackoverflow-answers > li > .accepted {
    color: #ffffff;
    background-color: #21759b;
}

#stackoverflow-answers > li > a {
    white-space: nowrap;
}
</style>
<script type="text/javascript">
(function ($) {
    var answersUrl = 'http://api.stackexchange.com/2.2/users/' + 497356 + '/answers'
        , questionsUrl = 'http://api.stackexchange.com/2.2/answers/{ids}/questions';
    
    function makeRequest(url, options) {
        return $.ajax({
            url: url,
            data: $.extend({
                site: 'stackoverflow'
            }, options)
        });
    }
    
    function getAnswers() {
        return makeRequest(answersUrl, {
            pagesize: 5,
            order: 'desc',
            site: 'stackoverflow',
            sort: 'creation',
            filter: '!9WgJfoIGL'
        });
    }

    function getQuestions(answerData) {
        var questionsDeferred = $.Deferred()
        , answerItems = answerData.items
        , answerIds = $.map(answerItems, function (answer) {
            return answer.answer_id;
        }).join(';');
        
        makeRequest(questionsUrl.replace("{ids}", answerIds))
        .done(function (data) {
            questionsDeferred.resolve(data, answerItems);
        });
        
        return questionsDeferred;
    }
    
    function processQuestions(questionData, answers) {
        var listItems;
    
        $.each(questionData.items, function (_, question) {
            var answer = $.grep(answers, function (ans) {
                return ans.question_id === question.question_id;
            })[0];
                        
            answer.title = question.title;
        });

        listItems = $.map(answers, function (answer) {
            var score = '<span class="score ' + (answer.is_accepted ? 'accepted' : '') + '">' + answer.score + '</span>'
                , link = '<a href="' + answer.link + '">' + answer.title + '</a>';
                
            return '<li>' + score + link + '</li>';
        }).join('');

        $('#stackoverflow-answers').html(listItems);    
    }    
        
    getAnswers()
        .then(getQuestions)
        .done(processQuestions);
    
})(jQuery);
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Andrew Whitaker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andrewwhitaker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.andrewwhitaker.com/blog/2014/08/15/queryover-series-part-7-using-sql-functions/';
        var disqus_url = 'http://www.andrewwhitaker.com/blog/2014/08/15/queryover-series-part-7-using-sql-functions/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
