
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>QueryOver Series - Part 6: Query Building Techniques - Andrew Whitaker</title>
  <meta name="author" content="Andrew Whitaker">

  
  <meta name="description" content="In this post, I&rsquo;m going to explain some more advanced techniques for building queries with QueryOver. Practically, this means adding joins and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.andrewawhitaker.com/blog/2014/08/07/queryover-series-part-6-query-building-techniques/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <link href="/atom.xml" rel="alternate" title="Andrew Whitaker" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Andrew Whitaker</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.andrewawhitaker.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/queryover-series">QueryOver Series</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">QueryOver Series - Part 6: Query Building Techniques</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-07T17:05:37-04:00" pubdate data-updated="true">Aug 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In this post, I&rsquo;m going to explain some more advanced techniques for building queries with QueryOver. Practically, this means adding joins and where clauses dynamically. This is actually one of the most powerful abilities of QueryOver so it&rsquo;s worth understanding.</p>

<!-- more -->


<p>To make this easier to explain, I&rsquo;m going to use a simple example that I can build on throughout the post.</p>

<h2>The Problem</h2>

<p>Imagine your company is building a page that lists all of the company&rsquo;s available products. On the left hand side, there are a few different filters the user can use to narrow his or her search.</p>

<p>You&rsquo;re immediately faced with a problem: How do I conditionally add where clauses and joins depending on the user&rsquo;s filters? If you&rsquo;re using a pure SQL solution, you would most likely need to build up dynamic SQL and then execute that. This will work fine, but you&rsquo;re immediately faced with a few other problems:</p>

<ul>
<li><strong>You&rsquo;re more open to SQL injection</strong>. Instead of using a parameterized query, a programmer could modify your query to concatenate user-inputted data into the query.</li>
<li><strong>You have a big maintainability problem</strong>. You&rsquo;re going to have to deal with giant strings of SQL. This isn&rsquo;t fun to read or modify.</li>
</ul>


<p>Both of these problems apply whether you&rsquo;re building the SQL in a stored procedure or if you&rsquo;re building SQL outside of the database engine (say, in your application layer).</p>

<h2>Solutions with QueryOver</h2>

<p>Using QueryOver to dynamically build queries is an attractive solution because it solves both problems:</p>

<ul>
<li>NHibernate is building the SQL behind the scenes using parameterized queries, so we don&rsquo;t have to worry about SQL injection.</li>
<li>Instead of looking at huge amounts of string concatenation, we&rsquo;re looking at more expressive .NET code. As a bonus, this is compiled with our application making it much more maintainable.</li>
</ul>


<p>Lets take a look at how we can dynamically construct queries with QueryOver. Keeping with our example, we&rsquo;ll start with a base query that retrieves information about all products:</p>

<p>Here&rsquo;s the DTO we&rsquo;re projecting to with our queries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductDTO</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Color</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">ListPrice</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&rsquo;s the basic query we&rsquo;ll be building on:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;</span> <span class="n">products</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Color</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToBean</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conditional Restrictions</h3>

<p>Continuing with our example, imagine we have a &ldquo;Color&rdquo; filter where the user can look for products only matching the colors they specify. Since <code>Product.Color</code> is a <code>string</code>, we&rsquo;ll introduce an <code>IEnumerable&lt;string&gt;</code> containing user-specified colors.</p>

<p>Adding this to our query gives us the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ProductDTO</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">colors</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">colors</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">.</span><span class="n">IsIn</span><span class="p">(</span><span class="n">colors</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;</span> <span class="n">products</span> <span class="p">=</span> <span class="n">query</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Color</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToBean</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our query has gotten a little more complicated, but it&rsquo;s still readable. Later on in the post, I&rsquo;ll show one way you can make this a bit more readable.</p>

<h3>Conditional Joins</h3>

<p>Sometimes you&rsquo;ll need to conditionally perform a join. One reason for this would be that a query <em>without</em> the join performs much better and you don&rsquo;t want to join unless you have to.</p>

<p>Lets add another filter to our example. Each <code>Product</code> in our domain has 0 to many <code>ProductReview</code>s. Let&rsquo;s add a filter that allows the user to find only products with a minimum user rating. For example, this would let a user find only products that have at least one rating of 3 stars or higher.</p>

<p>We&rsquo;ll add a <code>minimumRating</code> (a <code>Nullable&lt;int&gt;</code> where <code>null</code> indicates that the filter is not being used) and incorporate that into our query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ProductDTO</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">colors</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">colors</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">.</span><span class="n">IsIn</span><span class="p">(</span><span class="n">colors</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">minimumRating</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ProductReview</span> <span class="n">reviewAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="n">query</span><span class="p">.</span><span class="n">JoinAlias</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span> <span class="p">&gt;=</span> <span class="n">minimumRating</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;</span> <span class="n">products</span> <span class="p">=</span> <span class="n">query</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Color</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToBean</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is still more readable than dynamic SQL, but it&rsquo;s starting to look hairy. If we were to add a few more filters we&rsquo;d have a mess on our hands.</p>

<h3>Refactoring into Extension Methods</h3>

<p>One way to apply our filters conditionally is to use <a href="http://msdn.microsoft.com/en-us/library/bb383977.aspx">extension methods</a>. This will allow us to retain the flow of the QueryOver query so that it&rsquo;s a little easier to read.</p>

<p>Here&rsquo;s a static class containing our extension methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ProductQueryExtensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">ApplyColorFilter</span><span class="p">(</span>
</span><span class='line'>        <span class="k">this</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">colors</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">colors</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">colors</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">.</span><span class="n">IsIn</span><span class="p">(</span><span class="n">colors</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">query</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">ApplyRatingFilter</span><span class="p">(</span>
</span><span class='line'>        <span class="k">this</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>        <span class="kt">int?</span> <span class="n">minimumRating</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">minimumRating</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">ProductReview</span> <span class="n">reviewAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">query</span><span class="p">.</span><span class="n">JoinAlias</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Where</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span> <span class="p">&gt;=</span> <span class="n">minimumRating</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">query</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&rsquo;s our updated query using those extension methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;</span> <span class="n">products</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ApplyColorFilter</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ApplyRatingFilter</span><span class="p">(</span><span class="n">minimumRating</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Color</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ListPrice</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToBean</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">products</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is <em>much</em> easier to read and our filtering logic is in it&rsquo;s own class. As a bonus, it&rsquo;s reusable: we can reuse those same extension methods in another area of our application if we need to.</p>

<p>There are a few problems with this approach though&mdash;so let&rsquo;s address those.</p>

<h4>The extension methods only work on an <code>IQueryOver&lt;Product, Product&gt;</code></h4>

<p>This may not seem like a problem at first, but imagine we changed our query to start at another table. Say, for example, we wanted to start at <code>ProductReview</code> and <em>join</em> to <code>Product</code> instead of <em>starting</em> at <code>Product</code>. In that case, our extension methods would be useless since we aren&rsquo;t working with an <code>IQueryOver&lt;Product, Product&gt;</code> anymore, we&rsquo;re working with an <code>IQueryOver&lt;ProductReview, Product&gt;</code>.</p>

<p>The solution to this problem is to slightly change our extension methods to take advantage of the fact that when we&rsquo;re filtering we only care about <code>TSubType</code> (see <a href="../../../../2014/03/16/queryover-series-part-2-basics/">part 2, Basics and Joining</a> if you need a refresher on <code>TRoot</code> and <code>TSubType</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ProductQueryExtensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">TRoot</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">ApplyColorFilter</span><span class="p">&lt;</span><span class="n">TRoot</span><span class="p">&gt;(</span>
</span><span class='line'>        <span class="k">this</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">TRoot</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">colors</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">colors</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">colors</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Color</span><span class="p">.</span><span class="n">IsIn</span><span class="p">(</span><span class="n">colors</span><span class="p">.</span><span class="n">ToArray</span><span class="p">()));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">query</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">TRoot</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">ApplyRatingFilter</span><span class="p">&lt;</span><span class="n">TRoot</span><span class="p">&gt;(</span>
</span><span class='line'>        <span class="k">this</span> <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">TRoot</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>        <span class="kt">int?</span> <span class="n">minimumRating</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">minimumRating</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">ProductReview</span> <span class="n">reviewAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">query</span><span class="p">.</span><span class="n">JoinAlias</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Where</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span> <span class="p">&gt;=</span> <span class="n">minimumRating</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">query</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our extension methods will work on any QueryOver query whose <code>TSubType</code> is <code>Product</code>.</p>

<h4>Aliases may need to be passed around</h4>

<p>This is a more subtle problem and requires some understanding of how NHibernate generates SQL from QueryOver code.</p>

<p>Remember that QueryOver is built on top of the Criteria API for querying, and is really just a strongly-typed wrapper for that API using <a href="http://msdn.microsoft.com/en-us/library/bb397951.aspx">expression trees</a>.</p>

<p>What this means for aliases is that NHibernate is using the name of the variable you&rsquo;re using as an alias&mdash;parsing the expression you pass <code>.JoinAlias</code> or <code>.JoinQueryOver</code> into a <code>string</code> that&rsquo;s used with the QueryOver query&rsquo;s underlying criteria query.</p>

<p>This is easiest to see with an example.</p>

<p>Here&rsquo;s an example QueryOver query and its underlying Criteria query, as well as the SQL that&rsquo;s ultimately generated:</p>

<p><strong>QueryOver</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectGroup</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectMax</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Criteria</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">session</span><span class="p">.</span><span class="n">CreateCriteria</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Product</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">CreateCriteria</span><span class="p">(</span><span class="s">&quot;Reviews&quot;</span><span class="p">,</span> <span class="s">&quot;reviewAlias&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">ProjectionList</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">GroupProperty</span><span class="p">(</span><span class="s">&quot;Id&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="s">&quot;reviewAlias.Rating&quot;</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>These generate <em>identical</em> SQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>  <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span> <span class="k">AS</span> <span class="n">y0_</span><span class="p">,</span>
</span><span class='line'>  <span class="k">MAX</span> <span class="p">(</span><span class="n">reviewalia1_</span><span class="p">.</span><span class="n">Rating</span><span class="p">)</span> <span class="k">AS</span> <span class="n">y1_</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>  <span class="n">Production</span><span class="p">.</span><span class="n">Product</span> <span class="n">this_</span>
</span><span class='line'>  <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Production</span><span class="p">.</span><span class="n">ProductReview</span> <span class="n">reviewalia1_</span> <span class="k">ON</span>
</span><span class='line'>        <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span> <span class="o">=</span> <span class="n">reviewalia1_</span><span class="p">.</span><span class="n">ProductID</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span>
</span><span class='line'>  <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span>
</span></code></pre></td></tr></table></div></figure>


<p>The main thing to notice here is that the <em>name</em> of the alias (<code>reviewAlias</code>) we used in the QueryOver query is turned into a <code>string</code> which is ultimately used in the SQL query (<code>reviewalia1_</code>).</p>

<p>What this means is that you <strong>cannot</strong> write code like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinAlias</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">FilterQueryByRating</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">reviewAlias</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">query</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectGroup</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectMax</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Include only products with a rating &gt; 2   </span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FilterQueryByRating</span><span class="p">(</span>
</span><span class='line'>    <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ProductReview</span> <span class="n">reviewAlias</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">Restrictions</span><span class="p">.</span><span class="n">Gt</span><span class="p">(</span><span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">),</span> <span class="m">2</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do you see the problem? If we were to rename either <code>FilterQueryByRating</code>&rsquo;s <code>reviewAlias</code> parameter <em>or</em> the <code>reviewAlias</code> that the query is using, our query would not work. In other words, this will not work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Will explode:</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FilterQueryByRating</span><span class="p">(</span>
</span><span class='line'>    <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ProductReview</span> <span class="n">productReviewAlias</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">Restrictions</span><span class="p">.</span><span class="n">Gt</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">),</span> <span class="m">2</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll get an error stating &ldquo;could not resolve property: productReviewAlias&hellip;&rdquo;. This is because the alias we&rsquo;re using in the <code>Where</code> clause does not match the one we created when we joined to <code>ProductReview</code>.</p>

<p>This may not seem like a big deal, but you really don&rsquo;t want simply renaming an alias to cause queries to blow up. This is especially true if you&rsquo;re trying to reuse query building methods and you can&rsquo;t guarantee what variable name the user of your method will choose.</p>

<p>To solve this problem, we can create a helper method that will do something similar to what NHibernate is doing under the hood for us&mdash;combine expressions and create a projection from the resulting <code>string</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">PropertyProjection</span> <span class="n">BuildProjection</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aliasExpression</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">propertyExpression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="k">alias</span> <span class="p">=</span> <span class="n">ExpressionProcessor</span><span class="p">.</span><span class="n">FindMemberExpression</span><span class="p">(</span><span class="n">aliasExpression</span><span class="p">.</span><span class="n">Body</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">property</span> <span class="p">=</span> <span class="n">ExpressionProcessor</span><span class="p">.</span><span class="n">FindMemberExpression</span><span class="p">(</span><span class="n">propertyExpression</span><span class="p">.</span><span class="n">Body</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">Projections</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}.{1}&quot;</span><span class="p">,</span> <span class="k">alias</span><span class="p">,</span> <span class="n">property</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(<code>ExpressionProcessor</code> is a class under the <code>NHibernate.Impl</code> namespace)</p>

<p>We&rsquo;ll then update our filtering function to use it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">FilterQueryByRating</span><span class="p">(</span>
</span><span class='line'>    <span class="n">IQueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">,</span> <span class="n">Product</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">productReviewAlias</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">PropertyProjection</span> <span class="n">prop</span> <span class="p">=</span> <span class="n">BuildProjection</span><span class="p">&lt;</span><span class="n">ProductReview</span><span class="p">&gt;(</span>
</span><span class='line'>        <span class="n">productReviewAlias</span><span class="p">,</span> <span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Rating</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">query</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">Restrictions</span><span class="p">.</span><span class="n">Gt</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="m">2</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we need to make a small tweak to our main query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ProductReview</span> <span class="n">reviewAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinAlias</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">FilterQueryByRating</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">query</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectGroup</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectMax</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">))</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is much more robust: our filtering method doesn&rsquo;t even know what alias the query is using, and if that alias changes or someone decides to use our method in the future, everything will work fine.</p>

<h2>Summary</h2>

<p>I covered a lot in this post, but hopefully it will help you take advantage of QueryOver&rsquo;s most powerful features&mdash;building queries dynamically.</p>

<ul>
<li>Building queries with dynamic SQL can be a pain, but using QueryOver to dynamically build queries can be much easier and more maintainable.</li>
<li>Refactoring conditional restrictions and joins into extension methods can keep queries readable and refactor logic into reusable pieces.</li>
<li>To make those extension methods as robust as possible, we can make the methods generic and therefore more flexible.</li>
<li>Passing around aliases between methods when building QueryOver queries has some pitfalls and needs some special attention.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew Whitaker</span></span>

      








  


<time datetime="2014-08-07T17:05:37-04:00" pubdate data-updated="true">Aug 7<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nhibernate/'>nhibernate</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/06/28/queryover-series-part-5-materializing-results/" title="Previous Post: QueryOver Series - Part 5: Materializing Results">&laquo; QueryOver Series - Part 5: Materializing Results</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/15/queryover-series-part-7-using-sql-functions/" title="Next Post: QueryOver Series - Part 7: Using SQL Functions">QueryOver Series - Part 7: Using SQL Functions &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/24/queryover-series-part-8-working-with-subqueries/">QueryOver Series Part 8: Working with Subqueries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/28/getting-nhibernate-up-and-running-quickly/">Getting NHibernate Up and Running Quickly</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/queryover-series-part-7-using-sql-functions/">QueryOver Series - Part 7: Using SQL Functions</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/07/queryover-series-part-6-query-building-techniques/">QueryOver Series - Part 6: Query Building Techniques</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/28/queryover-series-part-5-materializing-results/">QueryOver Series - Part 5: Materializing Results</a>
      </li>
    
  </ul>
</section>





<section>
  <h1>Stack Overflow</h1>
  <a style="text-decoration:none;" href="http://stackoverflow.com/users/497356/andrew-whitaker">
    <img src="http://stackoverflow.com/users/flair/497356.png" width="208" height="58" alt="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
  </a>
  <h2>Recent Answers:</h2> 
  <ul id="stackoverflow-answers">
  </ul>
</section>
<style>
#stackoverflow-answers > li {
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

#stackoverflow-answers > li > .score {
    margin-right: 5px;
    padding: 3px 6px 6px 6px;
}

#stackoverflow-answers > li > .accepted {
    color: #ffffff;
    background-color: #21759b;
}

#stackoverflow-answers > li > a {
    white-space: nowrap;
}
</style>
<script type="text/javascript">
(function ($) {
    var answersUrl = 'http://api.stackexchange.com/2.2/users/' + 497356 + '/answers'
        , questionsUrl = 'http://api.stackexchange.com/2.2/answers/{ids}/questions';
    
    function makeRequest(url, options) {
        return $.ajax({
            url: url,
            data: $.extend({
                site: 'stackoverflow'
            }, options)
        });
    }
    
    function getAnswers() {
        return makeRequest(answersUrl, {
            pagesize: 5,
            order: 'desc',
            site: 'stackoverflow',
            sort: 'creation',
            filter: '!9WgJfoIGL'
        });
    }

    function getQuestions(answerData) {
        var questionsDeferred = $.Deferred()
        , answerItems = answerData.items
        , answerIds = $.map(answerItems, function (answer) {
            return answer.answer_id;
        }).join(';');
        
        makeRequest(questionsUrl.replace("{ids}", answerIds))
        .done(function (data) {
            questionsDeferred.resolve(data, answerItems);
        });
        
        return questionsDeferred;
    }
    
    function processQuestions(questionData, answers) {
        var listItems;
    
        $.each(questionData.items, function (_, question) {
            var answer = $.grep(answers, function (ans) {
                return ans.question_id === question.question_id;
            })[0];
                        
            answer.title = question.title;
        });

        listItems = $.map(answers, function (answer) {
            var score = '<span class="score ' + (answer.is_accepted ? 'accepted' : '') + '">' + answer.score + '</span>'
                , link = '<a href="' + answer.link + '">' + answer.title + '</a>';
                
            return '<li>' + score + link + '</li>';
        }).join('');

        $('#stackoverflow-answers').html(listItems);    
    }    
        
    getAnswers()
        .then(getQuestions)
        .done(processQuestions);
    
})(jQuery);
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Andrew Whitaker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andrewwhitaker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.andrewawhitaker.com/blog/2014/08/07/queryover-series-part-6-query-building-techniques/';
        var disqus_url = 'http://blog.andrewawhitaker.com/blog/2014/08/07/queryover-series-part-6-query-building-techniques/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
