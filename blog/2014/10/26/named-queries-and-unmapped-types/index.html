
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Named Queries and Unmapped Types - Andrew Whitaker</title>
  <meta name="author" content="Andrew Whitaker">

  
  <meta name="description" content="This post was inspired by this StackOverflow question. Named queries are extremely useful in a variety of situations when you&rsquo;re using &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.andrewawhitaker.com/blog/2014/10/26/named-queries-and-unmapped-types/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <link href="/atom.xml" rel="alternate" title="Andrew Whitaker" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Andrew Whitaker</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.andrewawhitaker.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/queryover-series">QueryOver Series</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Named Queries and Unmapped Types</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-26T16:38:35-05:00" pubdate data-updated="true">Oct 26<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><em>This post was inspired by <a href="http://stackoverflow.com/q/26512930/497356">this StackOverflow question</a></em>.</p>

<p>Named queries are extremely useful in a variety of situations when you&rsquo;re using NHibernate. If you want to use dialect-specific features that aren&rsquo;t supported in NHibernate, you&rsquo;re practically forced to go this route.</p>

<p>Another (possibly less common scenario) is this: you&rsquo;re working with a database and want to use a stored procedure. For some reason you cannot change the stored procedure.</p>

<!-- more -->


<p>On the surface, this doesn&rsquo;t sound problematic: Just map the stored procedure to a named query and execute it. What if the stored procedure returns a resultset whose column names are less than ideal?</p>

<p>To make this problem a bit more concrete, here&rsquo;s a simple stored procedure written against the AdventureWorks database that I&rsquo;ll work with for the rest of the post:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">create</span> <span class="k">procedure</span> <span class="p">[</span><span class="n">Products_GetAll</span><span class="p">]</span>
</span><span class='line'><span class="k">as</span> <span class="k">begin</span>
</span><span class='line'>  <span class="k">select</span>
</span><span class='line'>      <span class="p">[</span><span class="n">Production</span><span class="p">].[</span><span class="n">Product</span><span class="p">].[</span><span class="n">ProductID</span><span class="p">]</span> <span class="k">as</span> <span class="p">[</span><span class="n">prod_id</span><span class="p">],</span>
</span><span class='line'>      <span class="p">[</span><span class="n">Production</span><span class="p">].[</span><span class="n">Product</span><span class="p">].[</span><span class="n">Name</span><span class="p">]</span> <span class="k">as</span> <span class="p">[</span><span class="n">prod_name</span><span class="p">],</span>
</span><span class='line'>      <span class="p">[</span><span class="n">Production</span><span class="p">].[</span><span class="n">Product</span><span class="p">].[</span><span class="n">Color</span><span class="p">]</span> <span class="k">as</span> <span class="p">[</span><span class="n">prod_col</span><span class="p">]</span>
</span><span class='line'>  <span class="k">from</span>
</span><span class='line'>      <span class="p">[</span><span class="n">Production</span><span class="p">].[</span><span class="n">Product</span><span class="p">];</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our result type, <code>ProductDTO</code> has property names we&rsquo;d expect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductDTO</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Color</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With these pieces in mind, lets go over some possible solutions to our problem. I&rsquo;m assuming here that you don&rsquo;t want to just rename the properties on <code>ProductDTO</code>. You could certainly do that&mdash;however you&rsquo;d end up with some ugly property names, which is what we&rsquo;re trying to avoid.</p>

<p>So basically the rules are:</p>

<ul>
<li>We can&rsquo;t change the stored procedure</li>
<li>We want sane names for the properties in <code>ProductDTO</code></li>
</ul>


<h2>Map <code>ProductDTO</code></h2>

<p>Named queries can have a <code>&lt;return&gt;</code> element with a <code>class</code> attribute. If we went this route, our <code>.hbm.xml</code> file containing the named query might look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;hibernate-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;urn:nhibernate-mapping-2.2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;sql-query</span> <span class="na">name=</span><span class="s">&quot;Products_GetAll&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return</span> <span class="na">class=</span><span class="s">&quot;AdventureWorks.ProductDTO&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;return-property</span> <span class="na">name=</span><span class="s">&quot;ProductId&quot;</span> <span class="na">column=</span><span class="s">&quot;prod_id&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;return-property</span> <span class="na">name=</span><span class="s">&quot;ProductName&quot;</span> <span class="na">column=</span><span class="s">&quot;prod_name&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;return-property</span> <span class="na">name=</span><span class="s">&quot;ProductColor&quot;</span> <span class="na">column=</span><span class="s">&quot;prod_color&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/return&gt;</span>
</span><span class='line'>    exec [Products_GetAll];
</span><span class='line'>  <span class="nt">&lt;/sql-query&gt;</span>
</span><span class='line'><span class="nt">&lt;/hibernate-mapping&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This looks like it would work right? The problem is that if you go this route, <code>ProductDTO</code> must be mapped. If you try using this mapping with an unmapped class, NHibernate will throw an exception stating that it doesn&rsquo;t know what <code>ProductDTO</code> is.</p>

<p>This might actually make sense depending on your architecture, but if the stored procedure we&rsquo;re executing is purpose-built for a particular area of our application, it probably doesn&rsquo;t make sense to do that. I&rsquo;m thinking specifically of a domain-driven architecture where domain entities are mapped to tables in a database. If that&rsquo;s the architecture we&rsquo;re using then adding a <code>GetAllProducts</code> entity doesn&rsquo;t really make sense.</p>

<p>Furthermore, this stored procedure is simply a <em>query</em>. It doesn&rsquo;t really make sense to map something that&rsquo;s just used to query the same way we&rsquo;d map a table to a class that can be inserted/updated.</p>

<p>There&rsquo;s also the limitation that the poster of the StackOverflow question above had&mdash;his or her query returned a resultset that did not have a column/columns that could be used as an identifier. NHibernate requires that mapped classes have a column or combination of columns that can uniquely identify the row.</p>

<h2>Use LINQ to transform the result of executing the named query</h2>

<p>This solution involves using <code>&lt;return-scalar&gt;</code> in our named query. In other words, an <code>.hbm.xml</code> file that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;hibernate-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;urn:nhibernate-mapping-2.2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;sql-query</span> <span class="na">name=</span><span class="s">&quot;Products_GetAll&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return-scalar</span> <span class="na">column=</span><span class="s">&quot;prod_id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return-scalar</span> <span class="na">column=</span><span class="s">&quot;prod_name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return-scalar</span> <span class="na">column=</span><span class="s">&quot;prod_col&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    exec [Products_GetAll];
</span><span class='line'>  <span class="nt">&lt;/sql-query&gt;</span>
</span><span class='line'><span class="nt">&lt;/hibernate-mapping&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our C# to get the <code>Product</code>s list would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">GetNamedQuery</span><span class="p">(</span><span class="s">&quot;Products_GetAll&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">ProductDTO</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Id</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">obj</span><span class="p">[</span><span class="m">0</span><span class="p">],</span>
</span><span class='line'>        <span class="n">Name</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">obj</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
</span><span class='line'>        <span class="n">Color</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">obj</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>    <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will work fine. The problem is that it can become very unmanageable with more than 10 properties. NHibernate is supposed to get rid of code like this anyway. It feels like there should be a better solution.</p>

<h2>Use a Custom ResultTransformer</h2>

<p>The reason we can&rsquo;t use a built-in result transformer (i.e. one in the <code>NHibernate.Transform</code> namespace) is because the one that would be most useful, <code>AliasToBeanTransformer</code>, requires that we map aliases from the query to properties on the class we want to project into.</p>

<p>Unfortunately NHibernate doesn&rsquo;t allow us to do this mapping with a named query. We can, however, create a new result transformer that allows us to do that. We&rsquo;re using the same XML mapping for our named query as before:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;hibernate-mapping</span> <span class="na">xmlns=</span><span class="s">&quot;urn:nhibernate-mapping-2.2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;sql-query</span> <span class="na">name=</span><span class="s">&quot;Products_GetAll&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return-scalar</span> <span class="na">column=</span><span class="s">&quot;prod_id&quot;</span> <span class="na">type=</span><span class="s">&quot;integer&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return-scalar</span> <span class="na">column=</span><span class="s">&quot;prod_name&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;return-scalar</span> <span class="na">column=</span><span class="s">&quot;prod_col&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    exec [Products_GetAll];
</span><span class='line'>  <span class="nt">&lt;/sql-query&gt;</span>
</span><span class='line'><span class="nt">&lt;/hibernate-mapping&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are the steps you would take to map <code>ProductDTO</code> to the results of the query.</p>

<p><strong>1. Create an attribute that allows us to map column names to properties:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">[AttributeUsage(AttributeTargets.Property | AttributeTargets.Field, AllowMultiple = false)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">NHibernateQueryColumnAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">NHibernateQueryColumnAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">columnName</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">ColumnName</span> <span class="p">=</span> <span class="n">columnName</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">ColumnName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>2. Apply the attribute to our result class:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductDTO</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [NHibernateQueryColumn(&quot;prod_id&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [NHibernateQueryColumn(&quot;prod_name&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [NHibernateQueryColumn(&quot;prod_col&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Color</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>3. Create a result transformer that can leverage that attribute:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">NHibernate</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">NHibernate.Transform</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">QueryColumnAttributeTransformer</span><span class="p">&lt;</span><span class="n">TResultType</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">AliasedTupleSubsetResultTransformer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ConstructorInfo</span> <span class="n">constructor</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">MemberInfo</span><span class="p">&gt;</span> <span class="n">memberColumnMap</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">resultType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TResultType</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">QueryColumnAttributeTransformer</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">constructor</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">.</span><span class="n">GetConstructor</span><span class="p">(</span>
</span><span class='line'>            <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">,</span>
</span><span class='line'>            <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">Type</span><span class="p">.</span><span class="n">EmptyTypes</span><span class="p">,</span>
</span><span class='line'>            <span class="k">null</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">constructor</span> <span class="p">==</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">.</span><span class="n">IsClass</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span>
</span><span class='line'>                <span class="s">&quot;The target class of a QueryColumnAttributeTransformer needs a parameterless constructor&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">const</span> <span class="n">BindingFlags</span> <span class="n">flags</span> <span class="p">=</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">memberColumnMap</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">MemberInfo</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">MemberInfo</span><span class="p">[]</span> <span class="n">members</span> <span class="p">=</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">MemberInfo</span><span class="p">&gt;()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">.</span><span class="n">GetFields</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
</span><span class='line'>                <span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="n">MemberInfo</span> <span class="n">member</span> <span class="k">in</span> <span class="n">members</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">attr</span> <span class="p">=</span> <span class="n">member</span><span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">NHibernateQueryColumnAttribute</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="n">memberColumnMap</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">attr</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="n">member</span><span class="p">.</span><span class="n">Name</span> <span class="p">:</span> <span class="n">attr</span><span class="p">.</span><span class="n">ColumnName</span><span class="p">,</span> <span class="n">member</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">IsTransformedValueATupleElement</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">aliases</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tupleLength</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="kt">object</span> <span class="nf">TransformTuple</span><span class="p">(</span><span class="kt">object</span><span class="p">[]</span> <span class="n">tuple</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">aliases</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">aliases</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;aliases&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">object</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">.</span><span class="n">IsClass</span>
</span><span class='line'>                <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">constructor</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
</span><span class='line'>                <span class="p">:</span> <span class="n">NHibernate</span><span class="p">.</span><span class="n">Cfg</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">BytecodeProvider</span><span class="p">.</span><span class="n">ObjectsFactory</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">aliases</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="kt">string</span> <span class="k">alias</span> <span class="p">=</span> <span class="n">aliases</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">MemberInfo</span> <span class="n">member</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">memberColumnMap</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="k">alias</span><span class="p">,</span> <span class="k">out</span> <span class="n">member</span><span class="p">))</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="p">.</span><span class="n">MemberType</span> <span class="p">==</span> <span class="n">MemberTypes</span><span class="p">.</span><span class="n">Property</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="p">((</span><span class="n">PropertyInfo</span><span class="p">)</span><span class="n">member</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">member</span><span class="p">.</span><span class="n">MemberType</span> <span class="p">==</span> <span class="n">MemberTypes</span><span class="p">.</span><span class="n">Field</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="p">((</span><span class="n">FieldInfo</span><span class="p">)</span><span class="n">member</span><span class="p">).</span><span class="n">SetValue</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">tuple</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span>
</span><span class='line'>                        <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;{0} has no field or property mapped to column &#39;{1}&#39;&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">,</span> <span class="k">alias</span><span class="p">));</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="p">(</span><span class="n">MemberAccessException</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">HibernateException</span><span class="p">(</span><span class="s">&quot;Could not instantiate result class: &quot;</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">resultType</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">IList</span> <span class="nf">TransformList</span><span class="p">(</span><span class="n">IList</span> <span class="n">collection</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">collection</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>4. Use the result transformer in the query:</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">products</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">GetNamedQuery</span><span class="p">(</span><span class="s">&quot;Products_GetAll&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SetResultTransformer</span><span class="p">(</span><span class="k">new</span> <span class="n">QueryColumnAttributeTransformer</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ProductDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you don&rsquo;t like the idea of modifying your result class to accommodate the query, you could make a few changes to the transformer that would allow it to use a <code>Dictionary</code> mapping that you pass in instead.</p>

<p>Hope that helps someone out there. And if there&rsquo;s an easier way to accomplish this, please let me know.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew Whitaker</span></span>

      








  


<time datetime="2014-10-26T16:38:35-05:00" pubdate data-updated="true">Oct 26<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nhibernate/'>nhibernate</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/10/24/queryover-series-part-8-working-with-subqueries/" title="Previous Post: QueryOver Series Part 8: Working with Subqueries">&laquo; QueryOver Series Part 8: Working with Subqueries</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/10/26/named-queries-and-unmapped-types/">Named Queries and Unmapped Types</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/queryover-series-part-8-working-with-subqueries/">QueryOver Series Part 8: Working with Subqueries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/28/getting-nhibernate-up-and-running-quickly/">Getting NHibernate Up and Running Quickly</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/queryover-series-part-7-using-sql-functions/">QueryOver Series - Part 7: Using SQL Functions</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/07/queryover-series-part-6-query-building-techniques/">QueryOver Series - Part 6: Query Building Techniques</a>
      </li>
    
  </ul>
</section>





<section>
  <h1>Stack Overflow</h1>
  <a style="text-decoration:none;" href="http://stackoverflow.com/users/497356/andrew-whitaker">
    <img src="http://stackoverflow.com/users/flair/497356.png" width="208" height="58" alt="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
  </a>
  <h2>Recent Answers:</h2> 
  <ul id="stackoverflow-answers">
  </ul>
</section>
<style>
#stackoverflow-answers > li {
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

#stackoverflow-answers > li > .score {
    margin-right: 5px;
    padding: 3px 6px 6px 6px;
}

#stackoverflow-answers > li > .accepted {
    color: #ffffff;
    background-color: #21759b;
}

#stackoverflow-answers > li > a {
    white-space: nowrap;
}
</style>
<script type="text/javascript">
(function ($) {
    var answersUrl = 'http://api.stackexchange.com/2.2/users/' + 497356 + '/answers'
        , questionsUrl = 'http://api.stackexchange.com/2.2/answers/{ids}/questions';
    
    function makeRequest(url, options) {
        return $.ajax({
            url: url,
            data: $.extend({
                site: 'stackoverflow'
            }, options)
        });
    }
    
    function getAnswers() {
        return makeRequest(answersUrl, {
            pagesize: 5,
            order: 'desc',
            site: 'stackoverflow',
            sort: 'creation',
            filter: '!9WgJfoIGL'
        });
    }

    function getQuestions(answerData) {
        var questionsDeferred = $.Deferred()
        , answerItems = answerData.items
        , answerIds = $.map(answerItems, function (answer) {
            return answer.answer_id;
        }).join(';');
        
        makeRequest(questionsUrl.replace("{ids}", answerIds))
        .done(function (data) {
            questionsDeferred.resolve(data, answerItems);
        });
        
        return questionsDeferred;
    }
    
    function processQuestions(questionData, answers) {
        var listItems;
    
        $.each(questionData.items, function (_, question) {
            var answer = $.grep(answers, function (ans) {
                return ans.question_id === question.question_id;
            })[0];
                        
            answer.title = question.title;
        });

        listItems = $.map(answers, function (answer) {
            var score = '<span class="score ' + (answer.is_accepted ? 'accepted' : '') + '">' + answer.score + '</span>'
                , link = '<a href="' + answer.link + '">' + answer.title + '</a>';
                
            return '<li>' + score + link + '</li>';
        }).join('');

        $('#stackoverflow-answers').html(listItems);    
    }    
        
    getAnswers()
        .then(getQuestions)
        .done(processQuestions);
    
})(jQuery);
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Andrew Whitaker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andrewwhitaker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.andrewawhitaker.com/blog/2014/10/26/named-queries-and-unmapped-types/';
        var disqus_url = 'http://blog.andrewawhitaker.com/blog/2014/10/26/named-queries-and-unmapped-types/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
