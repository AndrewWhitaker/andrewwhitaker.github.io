
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>QueryOver Series - Part 4: Transforming - Andrew Whitaker</title>
  <meta name="author" content="Andrew Whitaker">

  
  <meta name="description" content="You might have noticed that the last post in the series always projects each result row into an object[]. This might have made you wonder if there& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.andrewwhitaker.com/blog/2014/06/19/queryover-series-part-4-transforming/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <link href="/atom.xml" rel="alternate" title="Andrew Whitaker" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Andrew Whitaker</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.andrewwhitaker.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/queryover-series">QueryOver Series</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">QueryOver Series - Part 4: Transforming</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-19T17:51:00-05:00" pubdate data-updated="true">Jun 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>You might have noticed that the last post in the series always projects each result row into an <code>object[]</code>. This might have made you wonder if there&rsquo;s a better way to get results from a QueryOver query. Well there is! It&rsquo;s called transforming.</p>

<p>In the context of an NHibernate query, a <em>transformer</em> is simply a class that transforms each row from a query into an instance of an object. NHibernate comes with several and allows you to easily create a custom transformer if you&rsquo;d like.</p>

<!-- more -->


<p><em>This article is part of an ongoing series on NHibernate Queryover. Click <a href="/queryover-series">here</a> to see the table of contents.</em></p>

<p>Transformers are supplied to the <code>TransformUsing</code> function on an instance of <code>IQueryOver&lt;TRoot, TSubtype&gt;</code>. For example, here&rsquo;s how you would use <code>Transformers.DistinctRootEntity</code> (which I&rsquo;ll go into more detail later about):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">results</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">DistinctRootEntity</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using the built-in transformers</h3>

<p>NHibernate supplies several built-in transformers in the <code>NHibernate.Transform</code> namespace. These may be all you need in your application since they cover most use cases. I&rsquo;ll go over each built-in transformer and how to use it.</p>

<h4><code>DistinctRootEntity</code></h4>

<p>This transformer works the way you&rsquo;d think it would: it transforms the query results into a list of <em>distinct</em> entities of the <em>root</em> type. What&rsquo;s the <em>root</em> type? Well if you read <a href="../../../../2014/03/12/queryover-series-part-1-why-queryover/">part 1</a>, you&rsquo;ll remember that a QueryOver query deals with two types, <code>TRoot</code> and <code>TSubType</code>. the root type is simply <code>TRoot</code>.</p>

<p>For example, here&rsquo;s a query that returns a list of all <code>Product</code>s:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// TRoot is Product</span>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">DistinctRootEntity</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, using <code>DistinctRootEntity</code> allows us to get a list of entities easily. This example doesn&rsquo;t address the <em>distinct</em> part of <code>DistinctRootEntity</code>. Here&rsquo;s another, more interesting example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">TransactionHistory</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">th</span> <span class="p">=&gt;</span> <span class="n">th</span><span class="p">.</span><span class="n">ActualCost</span> <span class="p">&gt;</span> <span class="m">2.0</span><span class="n">M</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">DistinctRootEntity</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is more interesting because a <code>Product</code> might have many related rows in <code>TransactionHistory</code>. The join would cause each <code>Product</code> to appear as many times as it has <code>TransactionHistory</code> records, which we probably don&rsquo;t want if we&rsquo;re just trying to find all <code>Product</code>s that were ever priced over $2.00.</p>

<p>Here&rsquo;s the SQL the above query generates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span> <span class="k">as</span> <span class="n">ProductID7_1_</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">-- All product columns</span>
</span><span class='line'>    <span class="n">transactio1_</span><span class="p">.</span><span class="n">TransactionID</span> <span class="k">as</span> <span class="n">Transact1_13_0_</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">-- All TransactionHistory columns</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">Production</span><span class="p">.</span><span class="n">Product</span> <span class="n">this_</span>
</span><span class='line'><span class="k">inner</span> <span class="k">join</span>
</span><span class='line'>    <span class="n">Production</span><span class="p">.</span><span class="n">TransactionHistory</span> <span class="n">transactio1_</span>
</span><span class='line'>        <span class="k">on</span> <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span><span class="o">=</span><span class="n">transactio1_</span><span class="p">.</span><span class="n">ProductID</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>    <span class="n">transactio1_</span><span class="p">.</span><span class="n">ActualCost</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result we  get back is a list of distinct <code>Product</code>s.</p>

<p><code>DistinctRootEntity</code> is most useful if you have a simple query in which you need instances of an entity and may or may not want to do filtering on some related entities.</p>

<h4><code>AliasToEntityMap</code></h4>

<p>This transformer allows you to transform each row of the result set into an <code>IDictionary</code> (hash table). Unfortunately it&rsquo;s not a generic <code>IDictionary</code>. The keys are strings containing the aliases you defined in the query, and the values are entities. This is best explained with an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">TransactionHistory</span> <span class="n">historyAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="n">Product</span> <span class="n">productAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">IDictionary</span><span class="p">&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">TransactionHistory</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">historyAlias</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">th</span> <span class="p">=&gt;</span> <span class="n">th</span><span class="p">.</span><span class="n">ActualCost</span> <span class="p">&gt;</span> <span class="m">2.0</span><span class="n">M</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToEntityMap</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">IDictionary</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each item in <code>results</code> is an <code>IDictionary</code>. This <code>IDictionary</code>&rsquo;s keys are the <em>aliases</em> we assigned while building our query. For example, if you wanted to get the first row&rsquo;s <code>TransactionHistory</code> entity, you would write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">TransactionHistory</span> <span class="n">history</span> <span class="p">=</span> <span class="p">(</span><span class="n">TransactionHistory</span><span class="p">)</span><span class="n">results</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="s">&quot;historyAlias&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>This might seem a bit odd at first, but using <code>AliasToEntityMap</code> can prove useful if you need to retrieve multiple entities in a single query.</p>

<h4><code>PassThrough</code></h4>

<p>This transformer appears to be quite similar to <code>AliasToEntityMap</code> in that it generates a collection of entities for each row in the resultset. I say &ldquo;appears&rdquo; because I haven&rsquo;t had much experience with it and I cannot find much about it online. I&rsquo;ll add to this post if I come across anything interesting.</p>

<p>Anyway for a simple example it seems to place an instance of an entity from the query in a slot in an <code>object</code> array in <em>reverse</em> order from when it was added to the query. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinAlias</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">reviewAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">TransactionHistory</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">th</span> <span class="p">=&gt;</span> <span class="n">th</span><span class="p">.</span><span class="n">ActualCost</span> <span class="p">&gt;</span> <span class="m">2.0</span><span class="n">M</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">PassThrough</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[]&gt;();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">foreach</span> <span class="p">(</span><span class="kt">object</span><span class="p">[]</span> <span class="n">result</span> <span class="k">in</span> <span class="n">results</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ProductReview</span> <span class="n">review</span> <span class="p">=</span> <span class="p">(</span><span class="n">ProductReview</span><span class="p">)</span><span class="n">result</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="n">TransactionHistory</span> <span class="n">t</span> <span class="p">=</span> <span class="p">(</span><span class="n">TransactionHistory</span><span class="p">)</span><span class="n">result</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
</span><span class='line'>    <span class="n">Product</span> <span class="n">p</span> <span class="p">=</span> <span class="p">(</span><span class="n">Product</span><span class="p">)</span><span class="n">result</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, <code>result[0]</code> is a <code>ProductReview</code>, <code>result[1]</code> is a <code>TransactionHistory</code> and <code>result[2]</code> is the <code>Product</code> itself.</p>

<h4><code>RootEntity</code></h4>

<p><code>RootEntity</code> is similar to <code>DistinctRootEntity</code> in that it projects a list of <code>TRoot</code>. The difference is that the results are <em>not</em> distinct. Therefore if you join on a related table that multiplies the root entity, you&rsquo;ll get back that entity many times for each related row. Here&rsquo;s the example from <code>DistinctRootEntity</code> again, except using <code>RootEntity</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">TransactionHistory</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">th</span> <span class="p">=&gt;</span> <span class="n">th</span><span class="p">.</span><span class="n">ActualCost</span> <span class="p">&gt;</span> <span class="m">2.0</span><span class="n">M</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">RootEntity</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will return any <code>Products</code> with a <code>TransactionHistory</code> that has an <code>ActualCost</code> over $2.00, but will not remove duplicate <code>Product</code> records.</p>

<h4><code>ToList</code></h4>

<p>This transformer works very similarly to not specifying a transformer at all and getting back an <code>IList&lt;object[]&gt;</code>. The difference here is that you&rsquo;ll get back an <code>IList&lt;IList&gt;</code> instead.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Product</span> <span class="n">productAlias</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">IList</span><span class="p">&gt;</span> <span class="n">results</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">TransactionHistory</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">th</span> <span class="p">=&gt;</span> <span class="n">th</span><span class="p">.</span><span class="n">ActualCost</span> <span class="p">&gt;</span> <span class="m">2.0</span><span class="n">M</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">ToList</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">IList</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">0</span><span class="p">]);</span> <span class="c1">// product Id</span>
</span><span class='line'><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="m">0</span><span class="p">][</span><span class="m">1</span><span class="p">]);</span> <span class="c1">// product Name</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>AliasToBean</code></h4>

<p>In my experience, this transformer is by far the most useful. It allows you to transform each row into an instance of a type you specify. You can project columns from different entities into properties on each instance.</p>

<p>Lets use <code>AliasToBean</code> to get a list of <code>HighestProductReviewDTO</code>s. Here&rsquo;s the definition for <code>HighestProductReviewDTO</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">HighestProductReviewDTO</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">ProductName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Rating</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Comments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>NHibernate requires that the DTO have a parameterless constructor so that it can create an instance of your class for each row it retrieves.</p>

<p>We&rsquo;re going to get a list of <code>Product</code>s that have reviews, followed by some information from that <code>Product</code>&rsquo;s highest review. Here&rsquo;s what our query looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">HighestProductReviewDTO</span><span class="p">&gt;</span> <span class="n">highestReviews</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">WithSubquery</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">QueryOver</span><span class="p">.</span><span class="n">Of</span><span class="p">&lt;</span><span class="n">ProductReview</span><span class="p">&gt;()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">rev</span> <span class="p">=&gt;</span> <span class="n">rev</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">rev</span> <span class="p">=&gt;</span> <span class="n">rev</span><span class="p">.</span><span class="n">Rating</span><span class="p">).</span><span class="n">Desc</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">rev</span> <span class="p">=&gt;</span> <span class="n">rev</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ProductID</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Name</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ProductName</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Rating</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">.</span><span class="n">Comments</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Comments</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToBean</span><span class="p">&lt;</span><span class="n">HighestProductReviewDTO</span><span class="p">&gt;())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">HighestProductReviewDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pay particular attention to the <code>.WithAlias</code> calls at the end of the <code>.Select</code> calls inside of <code>SelectList</code>. These are what tell NHibernate to associate particular column values in each row retrieved with the correct property in our DTO class.</p>

<p>In case you&rsquo;re curious, here&rsquo;s the SQL that NHibernate generated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span>
</span><span class='line'>    <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span> <span class="k">as</span> <span class="n">y0_</span><span class="p">,</span>
</span><span class='line'>    <span class="n">this_</span><span class="p">.</span><span class="n">Name</span> <span class="k">as</span> <span class="n">y1_</span><span class="p">,</span>
</span><span class='line'>    <span class="n">productrev1_</span><span class="p">.</span><span class="n">Rating</span> <span class="k">as</span> <span class="n">y2_</span><span class="p">,</span>
</span><span class='line'>    <span class="n">productrev1_</span><span class="p">.</span><span class="n">Comments</span> <span class="k">as</span> <span class="n">y3_</span>
</span><span class='line'><span class="k">FROM</span>
</span><span class='line'>    <span class="n">Production</span><span class="p">.</span><span class="n">Product</span> <span class="n">this_</span>
</span><span class='line'><span class="k">inner</span> <span class="k">join</span>
</span><span class='line'>    <span class="n">Production</span><span class="p">.</span><span class="n">ProductReview</span> <span class="n">productrev1_</span>
</span><span class='line'>        <span class="k">on</span> <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span><span class="o">=</span><span class="n">productrev1_</span><span class="p">.</span><span class="n">ProductID</span>
</span><span class='line'><span class="k">WHERE</span>
</span><span class='line'>    <span class="n">productrev1_</span><span class="p">.</span><span class="n">ProductReviewID</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>        <span class="k">SELECT</span>
</span><span class='line'>            <span class="n">TOP</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="n">this_0_</span><span class="p">.</span><span class="n">ProductReviewID</span> <span class="k">as</span> <span class="n">y0_</span>
</span><span class='line'>        <span class="k">FROM</span>
</span><span class='line'>            <span class="n">Production</span><span class="p">.</span><span class="n">ProductReview</span> <span class="n">this_0_</span>
</span><span class='line'>        <span class="k">WHERE</span>
</span><span class='line'>            <span class="n">this_0_</span><span class="p">.</span><span class="n">ProductID</span> <span class="o">=</span> <span class="n">this_</span><span class="p">.</span><span class="n">ProductID</span>
</span><span class='line'>        <span class="k">ORDER</span> <span class="k">BY</span>
</span><span class='line'>            <span class="n">this_0_</span><span class="p">.</span><span class="n">Rating</span> <span class="k">desc</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>AliasToBean</code> is extremely useful. It allows us to specify exactly what columns we need and transform the resulting rows into instances of simple types. However it does have some limitations:</p>

<ul>
<li>The class you&rsquo;re projecting to must have a parameterless constructor</li>
<li>You cannot populate collections (e.g., if you had a class with <code>ProductID</code> and a collection of <code>ProductReviews</code> you could not do that in one step using <code>AliasToBean</code>)</li>
<li>You cannot populate full entities (e.g., <code>.Select(() =&gt; productReview.Product).WithAlias(() =&gt; result.Product)</code>)</li>
</ul>


<p>While the second limitation is unfortunate, you <em>can</em> specify a collection type in your result class and write a separate query to populate it. You can possibly even do this in one database round trip using the <code>.Future</code> method, which I&rsquo;ll talk about in a later post.</p>

<h4><code>AliasToBeanConstructor</code></h4>

<p><code>AliasToBeanConstructor</code> is similar to <code>AliasToBean</code>, except that it uses a result type&rsquo;s constructor to create new objects from result rows. Here&rsquo;s our example from above slightly modified to use <code>AliasToBeanConstructor</code> instead.</p>

<p>Here&rsquo;s our modified result class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">HighestProductReviewDTO</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">HighestProductReviewDTO</span><span class="p">(</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">productId</span><span class="p">,</span> <span class="kt">string</span> <span class="n">productName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rating</span><span class="p">,</span> <span class="kt">string</span> <span class="n">comments</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">ProductID</span> <span class="p">=</span> <span class="n">productId</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">ProductName</span> <span class="p">=</span> <span class="n">productName</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Rating</span> <span class="p">=</span> <span class="n">rating</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Comments</span> <span class="p">=</span> <span class="n">comments</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">ProductName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Rating</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Comments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&rsquo;s our new QueryOver query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">HighestProductReviewDTO</span><span class="p">&gt;</span> <span class="n">highestReviews</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">JoinQueryOver</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Reviews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">WithSubquery</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">QueryOver</span><span class="p">.</span><span class="n">Of</span><span class="p">&lt;</span><span class="n">ProductReview</span><span class="p">&gt;()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">rev</span> <span class="p">=&gt;</span> <span class="n">rev</span><span class="p">.</span><span class="n">Product</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">rev</span> <span class="p">=&gt;</span> <span class="n">rev</span><span class="p">.</span><span class="n">Rating</span><span class="p">).</span><span class="n">Desc</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">rev</span> <span class="p">=&gt;</span> <span class="n">rev</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;())</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Id</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productAlias</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">.</span><span class="n">Rating</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">productReviewAlias</span><span class="p">.</span><span class="n">Comments</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="n">Transformers</span><span class="p">.</span><span class="n">AliasToBeanConstructor</span><span class="p">(</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="n">HighestProductReviewDTO</span><span class="p">).</span><span class="n">GetConstructors</span><span class="p">().</span><span class="n">First</span><span class="p">()))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">HighestProductReviewDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re passing <a href="http://msdn.microsoft.com/en-us/library/system.reflection.constructorinfo(v=vs.110).aspx"><code>ConstructorInfo</code></a> to <code>AliasToBeanConstructor</code> which we get using <code>GetConstructors</code>. NHibernate calls our constructor with the column values we&rsquo;re retrieving with our <code>SelectList</code>. Note that <em>all</em> items in the <code>SelectList</code> are passed to the constructor in the order you add them.</p>

<h3>Creating your own transformer</h3>

<p>The built in transformers are great, but if you need your own result transformer, that&rsquo;s possible too.</p>

<p>For example, let&rsquo;s say we want to call a callback function every time a row is transformed. We could also iterate over our results after retrieving them, but this gives us a way to apply any modifications we might want while we&rsquo;re transforming the row. Here&rsquo;s our new transformer class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">/// &lt;summary&gt;</span>
</span><span class='line'><span class="c1">/// A result transformer that calls a callback after successfully transforming a result row </span>
</span><span class='line'><span class="c1">/// into an instance of T</span>
</span><span class='line'><span class="c1">/// &lt;/summary&gt;</span>
</span><span class='line'><span class="c1">/// &lt;typeparam name=&quot;T&quot;&gt;The result type&lt;/typeparam&gt;</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AliasToBeanWithCallbackTransformer</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IResultTransformer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">AliasToBeanResultTransformer</span> <span class="n">aliasToBeanTransformer</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">callback</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">AliasToBeanWithCallbackTransformer</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">callback</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">aliasToBeanTransformer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AliasToBeanResultTransformer</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">callback</span> <span class="p">=</span> <span class="n">callback</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">IList</span> <span class="nf">TransformList</span><span class="p">(</span><span class="n">IList</span> <span class="n">collection</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">aliasToBeanTransformer</span><span class="p">.</span><span class="n">TransformList</span><span class="p">(</span><span class="n">collection</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">object</span> <span class="nf">TransformTuple</span><span class="p">(</span><span class="kt">object</span><span class="p">[]</span> <span class="n">tuple</span><span class="p">,</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">aliases</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">object</span> <span class="n">result</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">aliasToBeanTransformer</span><span class="p">.</span><span class="n">TransformTuple</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="n">aliases</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Call the callback before returning the result.</span>
</span><span class='line'>        <span class="n">callback</span><span class="p">((</span><span class="n">T</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, all I&rsquo;ve done is wrap <code>AliasToBeanResultTransformer</code> in a class that calls the callback the user specifies after calling <code>AliasToBeanResultTransformer</code>&rsquo;s <code>TransformTuple</code> method. I&rsquo;ll use this transformer in an example that retrieves product review information but with an added property, <code>DateRetrieved</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ProductReviewDTO</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">ProductReviewID</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Rating</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">Comments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">DateRetrieved</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use the transformer to assign <code>DateRetrieved</code> after creating a new <code>ProductReviewDTO</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">DateTime</span> <span class="n">dateRetrieved</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">IList</span><span class="p">&lt;</span><span class="n">ProductReviewDTO</span><span class="p">&gt;</span> <span class="n">highestReviews</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">session</span><span class="p">.</span><span class="n">QueryOver</span><span class="p">&lt;</span><span class="n">ProductReview</span><span class="p">&gt;()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">SelectList</span><span class="p">(</span><span class="n">list</span> <span class="p">=&gt;</span> <span class="n">list</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Comments</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Comments</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Id</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">ProductReviewID</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">pr</span> <span class="p">=&gt;</span> <span class="n">pr</span><span class="p">.</span><span class="n">Rating</span><span class="p">).</span><span class="n">WithAlias</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Rating</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="c1">// Assign &quot;DateRetrieved correctly:</span>
</span><span class='line'>        <span class="p">.</span><span class="n">TransformUsing</span><span class="p">(</span><span class="k">new</span> <span class="n">AliasToBeanWithCallbackTransformer</span><span class="p">&lt;</span><span class="n">ProductReviewDTO</span><span class="p">&gt;(</span>
</span><span class='line'>            <span class="n">hp</span> <span class="p">=&gt;</span> <span class="n">hp</span><span class="p">.</span><span class="n">DateRetrieved</span> <span class="p">=</span> <span class="n">dateRetrieved</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ProductReviewDTO</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a simple example, but it should demonstrate how easy it is to extend the built in transformers. It would be nice if we could subclass the built in transformers, but unfortunately the methods we would need to override are not marked <code>virtual</code>.</p>

<p>A good place to look for how to write a transformer is the <a href="https://github.com/nhibernate/nhibernate-core/tree/master/src/NHibernate/Transform">NHibernate source code itself</a>.</p>

<h3>Summary</h3>

<p>I covered a lot in this post, but I was aiming to be comprehensive with each transformer type. This should enable you to effectively use the built in transformers and create your own if you need to.</p>

<ul>
<li>There are several built in result transformers in the <code>NHibernate.Transform</code> namespace.</li>
<li><code>DistinctRootEntity</code> and <code>RootEntity</code> retrieve a list of the &ldquo;root&rdquo; of the QueryOver query</li>
<li><code>AliasToEntityMap</code> and <code>PassThrough</code> retrieve the entities present in the QueryOver query in an <code>IDictionary</code> and <code>object[]</code>, respectively.</li>
<li><code>AliasToBean</code> and <code>AliasToBeanConstructor</code> are powerful transformers that allow you to create a list of instances of a type you specify.</li>
<li>You can create your own result transformer pretty easily to suit your needs.</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Andrew Whitaker</span></span>

      








  


<time datetime="2014-06-19T17:51:00-05:00" pubdate data-updated="true">Jun 19<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nhibernate/'>NHibernate</a>, <a class='category' href='/blog/categories/queryover/'>QueryOver</a>, <a class='category' href='/blog/categories/queryover-series/'>QueryOver Series</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/03/22/queryover-series-part-3-selecting-and-transforming/" title="Previous Post: QueryOver Series - Part 3: Selecting">&laquo; QueryOver Series - Part 3: Selecting</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/06/28/queryover-series-part-5-materializing-results/" title="Next Post: QueryOver Series - Part 5: Materializing Results">QueryOver Series - Part 5: Materializing Results &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/31/queryover-series-part-10-combining-criteria-and-queryover/">QueryOver Series - Part 10: Combining Criteria and QueryOver</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/28/queryover-series-part-9-extending-queryover-using-custom-methods-and-properties/">QueryOver Series - Part 9: Extending QueryOver to Use Custom Methods and Properties</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/26/named-queries-and-unmapped-types/">Named Queries and Unmapped Types</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/24/queryover-series-part-8-working-with-subqueries/">QueryOver Series Part 8: Working with Subqueries</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/28/getting-nhibernate-up-and-running-quickly/">Getting NHibernate Up and Running Quickly</a>
      </li>
    
  </ul>
</section>





<section>
  <h1>Stack Overflow</h1>
  <a style="text-decoration:none;" href="http://stackoverflow.com/users/497356/andrew-whitaker">
    <img src="http://stackoverflow.com/users/flair/497356.png" width="208" height="58" alt="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for andrew-whitaker at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
  </a>
  <h2>Recent Answers:</h2> 
  <ul id="stackoverflow-answers">
  </ul>
</section>
<style>
#stackoverflow-answers > li {
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}

#stackoverflow-answers > li > .score {
    margin-right: 5px;
    padding: 3px 6px 6px 6px;
}

#stackoverflow-answers > li > .accepted {
    color: #ffffff;
    background-color: #21759b;
}

#stackoverflow-answers > li > a {
    white-space: nowrap;
}
</style>
<script type="text/javascript">
(function ($) {
    var answersUrl = 'http://api.stackexchange.com/2.2/users/' + 497356 + '/answers'
        , questionsUrl = 'http://api.stackexchange.com/2.2/answers/{ids}/questions';
    
    function makeRequest(url, options) {
        return $.ajax({
            url: url,
            data: $.extend({
                site: 'stackoverflow'
            }, options)
        });
    }
    
    function getAnswers() {
        return makeRequest(answersUrl, {
            pagesize: 5,
            order: 'desc',
            site: 'stackoverflow',
            sort: 'creation',
            filter: '!9WgJfoIGL'
        });
    }

    function getQuestions(answerData) {
        var questionsDeferred = $.Deferred()
        , answerItems = answerData.items
        , answerIds = $.map(answerItems, function (answer) {
            return answer.answer_id;
        }).join(';');
        
        makeRequest(questionsUrl.replace("{ids}", answerIds))
        .done(function (data) {
            questionsDeferred.resolve(data, answerItems);
        });
        
        return questionsDeferred;
    }
    
    function processQuestions(questionData, answers) {
        var listItems;
    
        $.each(questionData.items, function (_, question) {
            var answer = $.grep(answers, function (ans) {
                return ans.question_id === question.question_id;
            })[0];
                        
            answer.title = question.title;
        });

        listItems = $.map(answers, function (answer) {
            var score = '<span class="score ' + (answer.is_accepted ? 'accepted' : '') + '">' + answer.score + '</span>'
                , link = '<a href="' + answer.link + '">' + answer.title + '</a>';
                
            return '<li>' + score + link + '</li>';
        }).join('');

        $('#stackoverflow-answers').html(listItems);    
    }    
        
    getAnswers()
        .then(getQuestions)
        .done(processQuestions);
    
})(jQuery);
</script>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Andrew Whitaker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  - <span class="credit">Theme by <a href="http://www.gehaxelt.in">Gehaxelt</a></span>
  <span class="credit">and <a href="http://www.it-solutions-neef.de">IT Solutions Neef</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'andrewwhitaker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.andrewwhitaker.com/blog/2014/06/19/queryover-series-part-4-transforming/';
        var disqus_url = 'http://www.andrewwhitaker.com/blog/2014/06/19/queryover-series-part-4-transforming/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
